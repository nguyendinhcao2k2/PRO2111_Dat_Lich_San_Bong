<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <title>SÂN BÓNG VN</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <link rel="website icon" type="png"
          href="https://img.freepik.com/premium-vector/soccer-ball-logo-illustration-vector_472355-210.jpg?w=2000">
    <meta content="" name="keywords"/>
    <meta content="" name="description"/>
    <!-- Mobiscroll JS and CSS Includes -->
    <link
            href="https://cdn.jsdelivr.net/npm/fullcalendar@5.5.0/main.min.css"
            rel="stylesheet"
    />
    <link
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css"
            rel="stylesheet"
    />
    <!-- Quan Trọng -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.7.14/dist/vue.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <!--  -->
    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link
            href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500&family=Roboto:wght@400;500;700&display=swap"
            rel="stylesheet"
    />
    <!-- Icon Font Stylesheet -->
    <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css"
            integrity="sha512-MV7K8+y+gLIBoVD59lQIYicR65iaqukzvf/nwasF0nqhPay5w/9lJmVM2hMDcnK1OnMGCdVK+iQrJ7lzPJQd1w=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
    />
    <!-- Libraries Stylesheet -->
    <link th:href="@{/static/lib/animate/animate.min.css}" rel="stylesheet"/>
    <link th:href="@{/static/lib/owlcarousel/assets/owl.carousel.min.css}" rel="stylesheet">
    <link th:href="@{/static/lib/lightbox/css/lightbox.min.css}" rel="stylesheet">
    <!-- Customized Bootstrap Stylesheet -->
    <link th:href="@{/static/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/static/css/user/calendar-customer-book-field.css}" rel="stylesheet">
    <link th:href="@{/static/css/calendar/mobiscroll.jquery.min.css}" rel="stylesheet">

    <style>

        /* table container */

        scrollable-table {
            table-layout: fixed;
            border-collapse: collapse;
        }

        .scrollable-table thead {
            background-color: #f7f7f7;
            display: table;
            width: 100%;
            table-layout: fixed;
            border-collapse: collapse;
        }

        .scrollable-table tbody {
            display: block;
            max-height: 250px !important; /* Điều chỉnh chiều cao tối đa bạn muốn */
            overflow-y: auto;
            table-layout: fixed;
        }

        .scrollable-table tbody tr {
            display: table;
            width: 100%;
            table-layout: fixed;
            border-collapse: collapse;

        }

        .scrollable-table tbody td {
            /* border: 1px solid #000; */
            padding: 8px;
        }

        /*màu của trạng thái của sân ca và đặt lịch*/
        .event-class-1 {
            /* 1 là trạng thái đang đá*/
            background-color: #7cd28f; /* Example color */
            color: #fff;
        }

        .event-class-0 {
            /* 0 là trạng thái chờ nhận sân*/
            background-color: #6f42c1; /* Example color */
            color: #fff;
        }

        .event-class-3 {
            /* 3 là trạng thái Đã thanh toán*/
            background-color: #1a73e8; /* Example color */
            color: #fff;
        }

        .event-class-4 {
            /* 4 là trạng thái Đặt nhưng không đá*/
            background-color: #dc3545; /* Example color */
            color: #fff;
        }

        .event-class-over-time{
            /* đặt sau thời gian cho phép đặt*/
            background-color: #d35400; /* Example color */
            color: #fff;
        }
        .event-class {
            /*trạng thái tạo mới*/
            background-color: #009578; /* Example color */
            color: #fff;
        }

        .event-class-full {
            /*trạng thái sân đã full*/
            background-color: #fbc12d; /* Example color */
            color: #fff;
        }
        /*màu của trạng thái của sân ca và đặt lịch*/
        /*LAMNP UPDATE 28/10*/
        /* Đảm bảo tooltip có z-index cao hơn */
        .event-tooltip {
            position: relative;
            z-index: 9999;
            border: 1px solid #ccc;
            padding: 10px;
            width: auto !important; /* Cho tooltip co giãn dựa trên nội dung */
            max-width: 250px !important; /* Giới hạn chiều rộng tối đa */
            white-space: normal;
        }

        .event-tooltip h3 {
            color: #fff;
            font-size: 20px;
            margin: 0;
        }

        .event-tooltip br {
            color: #fff;
        }

        .event-tooltip p {
            margin: 5px 0;
        }

        /* Giới hạn chiều rộng tối đa của tooltip trên các thiết bị lớn hơn */
        @media (min-width: 768px) {
            .event-tooltip {
                max-width: 250px;
            }
        }

        /*END LÂM TEST*/
        .mbsc-material.mbsc-calendar-today, .mbsc-material.mbsc-calendar-week-nr {
            color: #2124B1;
            background-color: rgba(255, 220, 40, .15) !important;
        }

        .mbsc-material.mbsc-selected .mbsc-calendar-cell-text {
            background: rgba(188, 232, 241, .3);
            border-color: #1a73e8;
            color: #2124B1;
        }

        .fc .fc-highlight {
            border-color: #1a73e8;
        }

        .event-tooltip {
            z-index: 7; /* Đặt giá trị z-index cao hơn */
            color: #fff !important;
            border: 1px solid #2124B1 !important;
            border-radius: 12px;
        }

        .event-tooltip {
            pointer-events: none; /* Không tương tác với con chuột */
        }

        /*Croll table check in*/
        .table-container {
            max-height: 300px; /* Điều chỉnh độ cao tối đa của phần body */
            overflow-y: auto;
        }

        #idTable th,
        #idTable td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        #idTable th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }
    </style>
</head>
<body>
<div class=" bg-white p-0">
    <!-- Start Header -->
    <div th:insert="~{fragments/header}"></div>
    <!-- End Header -->
    <!-- Full Screen Search Start -->
    <div class="modal fade" id="searchModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content" style="background: rgba(29, 29, 39, 0.7)">
                <div class="modal-header border-0">
                    <button
                            type="button"
                            class="btn bg-white btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"
                    ></button>
                </div>
                <div
                        class="modal-body d-flex align-items-center justify-content-center"
                >
                    <div class="input-group" style="max-width: 600px">
                        <input
                                type="text"
                                class="form-control bg-transparent border-light p-3"
                                placeholder="Type search keyword"
                        />
                        <button class="btn btn-light px-4">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Full Screen Search End -->

    <!-- Service Start -->
    <!-- <div
             class="section-title position-relative text-center mb-5 pb-2 wow fadeInUp mt-5"
             data-wow-delay="0.1s"
     >
         <h2 class="mt-2">Liên Hệ Đặt Sân</h2>
     </div>-->
    <!--      Start Calendar-->
    <section class="container">
        <div class="card border-0 m-0 p-1">
            <div class="dat-lich-header-customer">
                <div class="body-row-col mt-0">
                    <div class="row">
                        <div class="col-md-6"></div>
                        <div class="col-md-6">
                            <!--                            thong bao-->
                            <div
                                    id="toastContainer"
                                    class="position-fixed osition-absolute top-0 end-0 p-3"
                                    style="z-index: 9999"
                            >
                                <div id="toasts" class="d-flex flex-column-reverse"></div>
                            </div>
                            <!--                            thong bao end-->
                            <div class="d-flex justify-content-end">
                                <!--button đổi lịch-->
                                <div>
                                    <button
                                            type="button"
                                            class="button-header btnDoiLichNhanh"
                                            onclick=""
                                            data-bs-toggle="modal" data-bs-target="#doiLichNhanh"
                                    >
                                        <span class="button__text">Đổi lịch nhanh</span>
                                        <span class="button__icon">
                                            <i class="fas fa-retweet fa-lg"></i>
                                        </span>
                                    </button>
                                </div>
                                <!-- Modal đổi lịch nhanh start-->
                                <div class="modal fade" id="doiLichNhanh" tabindex="-1"
                                     aria-labelledby="exampleModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-fullscreen">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="exampleModalLabel">
                                                    Đổi Lịch Nhanh
                                                </h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                        aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <!-- Nội dung modal -->
                                                <section class="bod app">
                                                    <div class="table-wrapper">
                                                        <div class="row">
                                                            <div class="col-md-12">
                                                                <div class="row">
                                                                    <div class="col-md-6">
                                                                        <h5 style="font-size: 35px" class="text-primary my-auto">Danh sách</h5>
                                                                    </div>

                                                                    <div class="col-md-6 d-md-flex justify-content-md-end">
                                                                        <button
                                                                                type="button"
                                                                                class="button-header-confirm modalXacNhan"
                                                                                data-bs-toggle="modal"
                                                                                data-bs-target="#modalConfirm"
                                                                        >
                                                                            <span class="button-text-confirm">Xác Nhận</span>
                                                                            <span class="button-icon-confirm">
                                                                                <i class="fas fa-check fa-lg"></i>
                                                                          </span>
                                                                        </button>

                                                                        <!--  -->
                                                                        <div class="modal modal-start"
                                                                             id="modalConfirm">
                                                                            <div class="modal-dialog modal-xl modal-dialog-centered">
                                                                                <div class="modal-content"
                                                                                     style="background-color: wheat">
                                                                                    <div class="modal-header">
                                                                                        <h5 class="modal-title">
                                                                                            Xác nhận đổi lịch
                                                                                        </h5>
                                                                                    </div>
                                                                                    <div class="modal-body">
                                                                                        <div class="table-responsive">
                                                                                            <table class="table table-hover tableFixHead">
                                                                                                <tr>
                                                                                                    <th>Ca cũ
                                                                                                    </th>
                                                                                                    <th>Loại sân
                                                                                                        cũ
                                                                                                    </th>
                                                                                                    <th>Ngày đá
                                                                                                        cũ
                                                                                                    </th>
                                                                                                    <th>Giá sân
                                                                                                        cũ
                                                                                                    </th>
                                                                                                    <th>Ca muốn
                                                                                                        đổi
                                                                                                    </th>
                                                                                                    <th>Loại sân
                                                                                                        muốn đổi
                                                                                                    </th>
                                                                                                    <th>Ngày
                                                                                                        muốn đổi
                                                                                                    </th>
                                                                                                    <th>Giá phải
                                                                                                        trả
                                                                                                    </th>
                                                                                                </tr>
                                                                                                <tr v-for="element in arrXacNhanLich">
                                                                                                    <td hidden>
                                                                                                        {{element.id}}
                                                                                                    </td>
                                                                                                    <td>
                                                                                                        {{element.caCu}}
                                                                                                    </td>
                                                                                                    <td>
                                                                                                        {{element.loaiSanCu}}
                                                                                                    </td>
                                                                                                    <td>
                                                                                                        {{element.ngayDaCu}}
                                                                                                    </td>
                                                                                                    <td>
                                                                                                        {{element.giaCu}}
                                                                                                    </td>
                                                                                                    <td>
                                                                                                        {{getByIdCa(element.caNew).tenCa}}
                                                                                                    </td>
                                                                                                    <td>
                                                                                                        {{getByIdLoaiSan(element.loaiSanNew).tenLoaiSan}}
                                                                                                    </td>
                                                                                                    <td>
                                                                                                        {{element.ngayNew}}
                                                                                                    </td>
                                                                                                    <td>
                                                                                                        {{element.giaNew}}
                                                                                                    </td>
                                                                                                </tr>
                                                                                            </table>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div class="modal-footer">

                                                                                        <div v-if="checkTienDoiLichNhieu()===0">
                                                                                            <form action="/api/v1/user/thanh-toan-nhieu/submitOrder"
                                                                                                  method="post">
                                                                                                <input type="hidden"
                                                                                                       name="amount"
                                                                                                       v-model="tienCocThieuDoiLichNhieu">
                                                                                                <input type="hidden"
                                                                                                       name="orderInfo"
                                                                                                       value="Tien coc doi san bong">
                                                                                                <button
                                                                                                        type="submit"
                                                                                                        class="btn btn-success btn-labeled btnGuiXacNhan"
                                                                                                        @click="thanhToanTienCocLichNhieu($event)"
                                                                                                >
                                                                                                    Xác nhận và
                                                                                                    thanh toán
                                                                                                    <i class="fas fa-check fa-lg"></i>
                                                                                                </button>
                                                                                            </form>

                                                                                        </div>
                                                                                        <div v-if="checkTienDoiLichNhieu()===1 || checkTienDoiLichNhieu()===2">
                                                                                            <button
                                                                                                    type="button"
                                                                                                    class="btn btn-success btn-labeled doiLichNhieuDuTienHoacKhong"
                                                                                            >
                                                                                                Xác nhận đổi
                                                                                                lịch
                                                                                                <i class="fas fa-check fa-lg"></i>
                                                                                            </button>
                                                                                        </div>
                                                                                        <button
                                                                                                type="button"
                                                                                                class="btn btn-danger btn-labeled closeModalXacNhanThongTinCon"

                                                                                        >
                                                                                            Đóng
                                                                                            <i class="fas fa-times fa-lg"></i>
                                                                                        </button>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <!--  -->
                                                                    </div>
                                                                </div>

                                                                <hr/>
                                                                <table class="table tableList">
                                                                    <tr>
                                                                        <th>
                                                                            <input
                                                                                    class="form-check-input check-all"
                                                                                    type="checkbox"
                                                                                    value=""
                                                                                    aria-label="Checkbox for following text input"
                                                                            />
                                                                        </th>
                                                                        <th>Ca hiện tại</th>
                                                                        <th>Loại sân</th>
                                                                        <th>Ngày đá dự kiến</th>
                                                                        <th>Giá</th>
                                                                        <th>Ca muốn đổi</th>
                                                                        <th>Ngày muốn đổi</th>
                                                                        <th>Loại sân muốn đổi</th>
                                                                        <th>Giá dự kiến</th>
                                                                    </tr>
                                                                    <tr v-for="items in arrLichCanDoi">
                                                                        <td class="check-box-one">
                                                                            <input
                                                                                    class="form-check-input mt-0 check-one"
                                                                                    type="checkbox"
                                                                                    aria-label="Checkbox for following text input"
                                                                                    v-bind:value="items.id"
                                                                            />
                                                                        </td>
                                                                        <td class="ca-ht">{{items.tenCa}}</td>
                                                                        <td class="loai-san-ht">
                                                                            {{items.tenLoaiSan}}
                                                                        </td>
                                                                        <td class="time-da-bong">
                                                                            {{items.ngayDenSan}}
                                                                        </td>
                                                                        <td class="tong-tien">
                                                                            {{currenlyNumberVue(items.tienSan)}}
                                                                        </td>
                                                                        <td>
                                                                            <select class="form-select ca-sb">
                                                                                <option
                                                                                        v-bind:value="loaiCa.id"
                                                                                        :selected="loaiCa.id == items.idCa"
                                                                                        v-for="loaiCa in arrCaDL"
                                                                                >
                                                                                    {{loaiCa.tenCa}}
                                                                                </option>
                                                                            </select>
                                                                        </td>
                                                                        <td>
                                                                            <input
                                                                                    type="date"
                                                                                    class="form-control change-time ngayNhieu"
                                                                                    id="datePicker"
                                                                                    :min="dateNow()"
                                                                            />
                                                                        </td>
                                                                        <td>
                                                                            <select class="form-select loai-san">
                                                                                <option
                                                                                        v-bind:value="loaiSan.id"
                                                                                        :selected="loaiSan.id == items.idLoaiSan"
                                                                                        v-for="loaiSan in arrLoaiSanDL"
                                                                                >
                                                                                    {{loaiSan.tenLoaiSan}}
                                                                                </option>
                                                                            </select>
                                                                        </td>
                                                                        <td class="giaDuKienPhaiTra">
                                                                            {{currenlyNumberVue(items.tienSan)}}
                                                                        </td>
                                                                    </tr>
                                                                    <tr>
                                                                        <td>Tổng tiền</td>

                                                                        <td style="color: red;size: 25px"
                                                                            colspan="4">
                                                                            {{currenlyNumberVue(tongTienSanCu)}}
                                                                        </td>
                                                                        <td style="color: red;size: 25px"
                                                                            colspan="4">
                                                                            {{currenlyNumberVue(tongTienSanMoi)}}
                                                                        </td>
                                                                    </tr>
                                                                    <tr v-if="checkTienDoiLichNhieu() === 0">
                                                                        <td>Tiền cọc còn thiếu</td>
                                                                        <td colspan="9"
                                                                            style="font-size: 30px;color: red">
                                                                            {{currenlyNumberVue(tinhTienCocLichNhieu())}}
                                                                        </td>
                                                                    </tr>
                                                                    <tr v-if="checkTienDoiLichNhieu() === 1">
                                                                        <td>Tiền cọc thừa</td>
                                                                        <td colspan="9"
                                                                            style="font-size: 30px;color: red">
                                                                            {{currenlyNumberVue(tinhTienCocLichNhieu())}}
                                                                        </td>
                                                                    </tr>
                                                                </table>
                                                            </div>
                                                            <div class="col-md-12">
                                                                <section class="gather" hidden>
                                                                    <div class="row">
                                                                        <div class="col-md-12">
                                                                            <h1>Đổi lịch chung</h1>
                                                                            <hr/>
                                                                        </div>
                                                                        <div class="col-md-3" style="color: black">
                                                                            Ca chung:
                                                                            <select class="form-select ca-chung">
                                                                                <option
                                                                                        v-bind:value="items.id"
                                                                                        v-for="items in arrCaDL"
                                                                                >
                                                                                    {{items.tenCa}}
                                                                                </option>
                                                                            </select>
                                                                        </div>

                                                                        <div class="col-md-6 dai-ngay">
                                                                            <div
                                                                                    class="d-grid gap-2 d-md-flex justify-content-md-center"
                                                                            >
                                                                                <button
                                                                                        type="button"
                                                                                        class="btn btn-outline-danger btnTheoNgay"
                                                                                >
                                                                                    Theo ngày
                                                                                </button>
                                                                                <button
                                                                                        type="button"
                                                                                        class="btn btn-outline-warning btnTheoTuan"
                                                                                >
                                                                                    Theo tuần
                                                                                </button>
                                                                            </div>

                                                                            <div
                                                                                    class="d-grid gap-2 d-md-flex justify-content-md-center"
                                                                            >
                                                                                <div class="dateTheoNgay">
                                                                                    <div style="height: 100%">
                                                                                        <div class="mbsc-grid">
                                                                                            <div style="width: 500px">
                                                                                                <div class="mbsc-form-group">
                                                                                                    <div id="demo-counter"></div>
                                                                                                </div>
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>

                                                                                <div class="dateTheoTuan mt-4"
                                                                                     hidden>
                                                                                    <div
                                                                                            mbsc-page
                                                                                            class="demo-range-select"
                                                                                            style="width: 500px; border-color: #ccc"
                                                                                    >
                                                                                        <div style="height: 100%">
                                                                                            <div id="datLichTheoTuans"></div>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>

                                                                        <div class="col-md-3" style="color: black">
                                                                            Loại sân chung
                                                                            <select class="form-select loai-san-chung">
                                                                                <option
                                                                                        v-bind:value="items.id"
                                                                                        v-for="items in arrLoaiSanDL"
                                                                                >
                                                                                    {{items.tenLoaiSan}}
                                                                                </option>
                                                                            </select>
                                                                        </div>
                                                                    </div>
                                                                </section>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </section>
                                                <!-- Nội dung modal -->
                                                <p>...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Modal đổi lịch nhanh end-->
                                <!--                                -->
                                <!--                                -->
                                <div>
                                    <select class="select-loai-san" id="selectLoaiSan"
                                            onchange="resetEventByIdLoaiSan(this.value);">
                                        <option th:each="loaiSan : ${listLoaiSan}"
                                                th:selected="${loaiSan.tenLoaiSan == 'Sân 7'}"
                                                th:value="${loaiSan.id}" th:text="${loaiSan.tenLoaiSan}"></option>
                                    </select>
                                </div>
                                <!-- modal info điền thông tin -->
                                <div>
                                    <button
                                            type="button"
                                            class="button-header"
                                            onclick="showModalInfo()"
                                    >
                                        <span class="button__text">Thông Tin</span>
                                        <span class="button__icon">
                                            <i class="fas fa-info"></i>
                                        </span>
                                    </button>
                                    <!-- modal điền thông tin sân  -->
                                    <div class="modal " id="modalInfo">
                                        <div class="modal-dialog modal-xl">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title">Đặt Sân</h5>
                                                    <button
                                                            type="button"
                                                            class="btn-close"
                                                            data-bs-dismiss="modal"
                                                    ></button>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="row">
                                                        <div class="col-md-4 col-sm-auto">
                                                            <form>
                                                                <div class="mb-3">
                                                                    <label class="form-label required"
                                                                    >Họ và tên</label
                                                                    >
                                                                    <input type="text" id="hoVaTen"
                                                                           class="form-control"/>
                                                                    <span id="hoVaTen_erro" class="text-danger"></span>
                                                                </div>
                                                                <div class="mb-3">
                                                                    <label class="form-label required"
                                                                    >Email</label
                                                                    >
                                                                    <input type="email" id="mail" class="form-control"/>
                                                                    <span id="mail_erro" class="text-danger"></span>
                                                                </div>
                                                                <div class="mb-3">
                                                                    <label class="form-label required"
                                                                    >Số điện thoại</label
                                                                    >
                                                                    <input type="text" id="sdt" class="form-control"/>
                                                                    <span id="sdt_erro" class="text-danger"></span>
                                                                </div>
                                                                <div class="mb-3">
                                                                    <label class="form-label required"
                                                                    >Ghi chú</label
                                                                    >
                                                                    <textarea class="form-control"
                                                                              id="remark"></textarea>
                                                                </div>
                                                            </form>
                                                        </div>
                                                        <div class="col-md-8 col-sm-auto ">
                                                            <div class="table-container">
                                                                <table
                                                                        class="table table-bordered table-hover"
                                                                        style="color: black"
                                                                        id="myTable"
                                                                >
                                                                    <thead>
                                                                    <tr>
                                                                        <th style="width: 270px;">Ca</th>
                                                                        <th>Ngày</th>
                                                                        <th>Giá sân</th>
                                                                        <th>Thao tác</th>
                                                                    </tr>
                                                                    </thead>
                                                                    <tbody id="listEventNew"
                                                                           style="max-height: 300px; overflow-y: auto;">

                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                            <div class="card text-bg-light p-2" style="border-radius: 0px">
                                                                <div class="row">
                                                                    <div class="col-6 col-md-6 col-sm-6">
                                                                        <h4
                                                                        >
                                                                            Tổng tiền sân:
                                                                        </h4>
                                                                    </div>
                                                                    <div class="col-6 col-md-6 col-sm-6">
                                                                        <h4
                                                                                class=" text-center text-primary"
                                                                                id="id_tongTien"
                                                                        >
                                                                            600000 VND
                                                                        </h4>
                                                                    </div>
                                                                    <div class="col-6 col-md-6 col-sm-6">
                                                                        <h4
                                                                        >
                                                                            Tổng tiền cọc:
                                                                        </h4>
                                                                    </div>
                                                                    <div class="col-6 col-md-6 col-sm-6">
                                                                        <h4
                                                                                class=" text-center text-primary"
                                                                                id="id_tienCoc"
                                                                        >
                                                                            600000 VND
                                                                        </h4>
                                                                    </div>

                                                                </div>
                                                            </div>

                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">

                                                    <button
                                                            type="button"
                                                            class="btn btn-danger btn-labeled"
                                                            data-bs-dismiss="modal"
                                                    >
                                                        Đóng
                                                        <i class="fas fa-times fa-lg"></i>
                                                    </button>
                                                    <button type="submit" class="btn btn-success btn-labeled"
                                                            onclick="xacNhanDatLich()">
                                                        Đặt lịch và thanh toán
                                                        <i class="fas fa-check fa-lg"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!--  -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="row">
                        <!--Mobiscroll-->
                        <div
                                class="col-12 col-sm-12 col-md-3 p-1"
                                style="border-right: #171717 1px;    width: 20%;"
                        >
                            <div class="demo-multiple-select">
                                <div class="mbsc-form-group">
                                    <div class="mbsc-form-group-title">
                                        <h5 class="text-center">Chọn Ngày</h5>
                                    </div>
                                    <div>
                                        <div class="mbsc-form-group">
                                            <div
                                                    id="demo-single-select-date"
                                                    class="datePicker"
                                            ></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- FULL CALENDAR -->
                        <div class="col-12 col-sm-12 col-md-6 p-1" style="width: 55%;">
                            <div class="body-row-col">
                                <div>
                                    <div id="calendar"></div>
                                    <div id="myModal1" class="modal">
                                        <div class="modal-dialog modal-lg" style="max-width: 650px">
                                            <div class="modal-content">
                                                <div class="modal-header" style="">
                                                    <h6 class="modal-title">Lựa Chọn Ca</h6>
                                                    <span class="close" id="closeModal1">&times;</span>
                                                </div>
                                                <div
                                                        class="modal-body"
                                                        style="max-height: 300px; overflow-y: auto"
                                                >
                                                    <!-- ca -->
                                                    <div class="row" id="list">

                                                    </div>
                                                    <!-- end ca -->
                                                    <!-- ngày -->
                                                    <div>
                                                        <div class="header m-2">
                                                            <h4 class="">Đặt Lịch</h4>
                                                        </div>
                                                        <div class="row">
                                                            <div class="col-md-5">
                                                                <div>
                                                                    <select
                                                                            class="form-select"
                                                                            name="tinhTrang"
                                                                            id="dateSelect"
                                                                    >
                                                                        <option value="0" selected>
                                                                            Theo ngày
                                                                        </option>
                                                                        <option value="1">Nhiều ngày</option>
                                                                        <option value="2">Theo tuần</option>
                                                                    </select>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-7">
                                                                <div class="mbsc-form-group m-0 p-0">
                                                                    <div id="demo-multi-day"></div>
                                                                    <div id="demo-range-selection"></div>
                                                                    <div id="demo-week-select"></div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <!-- end ngày -->
                                                </div>
                                                <div class="modal-footer">
                                                    <div class="d-flex flex-row-reverse bd-highlight">
                                                        <div class="p-1 bd-highlight">
                                                            <button
                                                                    type="button"
                                                                    class="btn btn-success btn-labeled"
                                                                    id="luuCaCellDay"
                                                            >
                                                                Lưu Ca
                                                                <i
                                                                        class="far fa-save fa-lg"
                                                                        style="color: #f2f2f3"
                                                                ></i>
                                                            </button>
                                                        </div>
                                                        <div class="p-1 bd-highlight">
                                                            <button
                                                                    type="button"
                                                                    class="btn btn-danger btn-labeled"
                                                                    onclick="closeModal1()"
                                                            >
                                                                Hủy
                                                                <i
                                                                        class="fas fa-times fa-lg"
                                                                        style="color: #f5f5f5"
                                                                ></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!--EVENT CLICK-->
                        <div class="col-12 col-sm-12 col-md-3 p-1">
                            <div class="body-row-col">
                                <div class="header-text-body">
                                    <h5>Sự Kiện</h5>
                                    <hr/>
                                </div>
                                <div class="table-container">
                                    <table
                                            class="table table-bordered table-hover click-event-fullcalendar"
                                            style="color: black"
                                            id="idTable"
                                    >
                                        <thead>
                                            <tr>
                                                <th>Thông tin ca</th>
                                                <th>Thao tác</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tableShow"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <!-- Modal doi lich one start -->
                        <div class="modal" id="doiLichOne" style="overflow-y: auto;">
                            <div class="modal-dialog modal-xl">
                                <div class="modal-content">
                                    <div class="modal-header" style="background: #f7941e">
                                        <h5 class="modal-title" style="color: #fff; font-size: 25px ">Xác Nhận Đổi Lịch</h5>
                                    </div>
                                    <div class="modal-body">
                                        <div class="table-responsive">
                                            <table class="table table-hover ">
                                                <tr>
                                                    <th>Ca hiện tại</th>
                                                    <th>Loại sân</th>
                                                    <th>Ngày đá dự kiến</th>
                                                    <th>Tiền sân cũ</th>
                                                    <th>Ca muốn đổi</th>
                                                    <th>Loại sân muốn đổi</th>
                                                    <th>Ngày muốn đổi</th>
                                                    <th>Tiền sân dự kiến</th>
                                                    <th v-if="checkTienCoc() === 0" style="color: red">Tiền
                                                        cọc còn thiếu
                                                    </th>
                                                    <th v-if="checkTienCoc() === 1" style="color: red">Tiền
                                                        cọc thừa
                                                    </th>
                                                </tr>
                                                <tr>
                                                    <td>{{lichDatCu.caHT}} - {{lichDatCu.thoiGianBatDau}} :
                                                        {{lichDatCu.thoiGianKetThuc}}
                                                    </td>
                                                    <td>{{lichDatCu.loaiSan}}</td>
                                                    <td>{{currenDateLichOne(lichDatCu.ngayDaDuKien)}}</td>
                                                    <td>{{currenNumberVNLichOne(lichDatCu.tienSan)}}</td>
                                                    <td>
                                                        <select class="form-select "
                                                                aria-label="Default select example"
                                                                @change="selectCaDoiLich">
                                                            <option v-for="items in listCa"
                                                                    :selected="lichDatCu.idCa == items.id"
                                                                    v-bind:value="items.id">{{items.tenCa}}
                                                            </option>
                                                        </select>
                                                    </td>
                                                    <td>
                                                        <select class="form-select "
                                                                aria-label="Default select example"
                                                                @change="selectLoaiSanDoiLich">
                                                            <option v-for="items in listLoaiSan"
                                                                    :selected="lichDatCu.idLoaiSan == items.id"
                                                                    v-bind:value="items.id">{{items.tenLoaiSan}}
                                                            </option>
                                                        </select>
                                                    </td>
                                                    <td>
                                                        <div class="input-group flex-nowrap">
                                                            <input type="date" class="form-control ngayMuonDoi"
                                                                   id="dateInput"
                                                                   v-bind:value="lichDatCu.ngayDaDuKien"
                                                                   aria-describedby="addon-wrapping">
                                                        </div>
                                                    </td>
                                                    <td>{{currenNumberVNLichOne(tienPhaiTra)}}</td>
                                                    <td v-if="checkTienCoc() === 0" style="color: red">
                                                        <marquee>{{currenNumberVNLichOne(tinhTienCoc())}}</marquee>
                                                    </td>
                                                    <td v-if="checkTienCoc() === 1" style="color: red">
                                                        <marquee>{{currenNumberVNLichOne(tinhTienCoc())}}</marquee>
                                                    </td>
                                                </tr>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button
                                                type="button"
                                                class="btn btn-success btn-labeled "
                                                data-bs-toggle="modal" data-bs-target="#modalConfirmDoiLich"
                                                @click="btnXacNhanDoiLich"
                                                name="next"
                                        >
                                            Đổi lịch
                                            <i class="fas fa-check fa-lg"></i>
                                        </button>
                                        <button
                                                type="button"
                                                class="btn btn-danger btn-labeled closeModalFather"
                                                data-bs-dismiss="modal"
                                        >
                                            Đóng
                                            <i class="fas fa-times fa-lg"></i>
                                        </button>
                                    </div>
                                    <!-- Modal -->
                                    <section class="modalCon">
                                        <div class="modal fade" id="modalConfirmDoiLich"
                                             aria-labelledby="exampleModalLabel" aria-hidden="true">
                                            <div class="modal-dialog">
                                                <form id="formDoiLichOne" action="/api/v1/user/tien-coc/create-payment"
                                                      method="post">
                                                    <input type="hidden" name="amount" v-model="tienCocThieu">
                                                    <input type="hidden" name="orderInfo" v-model="noiDung">
                                                    <div class="modal-content" style="background-color: wheat">
                                                        <div class="modal-header">
                                                            <h1 class="modal-title fs-5" id="exampleModalLabel">Thông
                                                                báo</h1>
                                                        </div>
                                                        <div class="modal-body">
                                                            Bạn có chắc chắn thực hiện hành động?
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-danger closeXacNhanOne"
                                                            >
                                                                <i class="fa fa-ban" aria-hidden="true"></i>
                                                                Hủy
                                                            </button>
                                                            <button type="submit" class="btn btn-success">
                                                                <i class="fa fa-check" aria-hidden="true"></i>
                                                                Đổi lịch và thanh toán
                                                            </button>
                                                        </div>
                                                    </div>
                                                </form>

                                            </div>
                                        </div>
                                    </section>
                                    <!-- Modal -->
                                </div>
                            </div>
                        </div>
                        <!-- Modal doi lich one end -->
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- Service End -->


    <!-- Start Footer -->
    <div th:insert="~{fragments/footer}"></div>
    <!-- End Footer -->

</div>

<!-- JavaScript Libraries -->
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/static/lib/wow/wow.min.js}"></script>
<script th:src="@{/static/lib/easing/easing.min.js}"></script>
<script th:src="@{/static/lib/waypoints/waypoints.min.js}"></script>
<script th:src="@{/static/lib/owlcarousel/owl.carousel.min.js}"></script>
<script th:src="@{/static/lib/isotope/isotope.pkgd.min.js}"></script>
<script th:src="@{/static/lib/lightbox/js/lightbox.min.js}"></script>

<!-- END Full Calendar -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.5.0/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/locales/vi.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
<!--<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"></script>-->
<!--<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"></script>-->
<!-- Template Javascript -->
<script th:src="@{/static/js/utill/thong-bao.js}"/>
<script th:src="@{/static/js/main.js}"></script>
<script th:src="@{/static/js/lib/mobiscroll.jquery.min.js}"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // Biến lưu trữ đối tượng lịch để sử dụng trong openModal
    var calendar;
    // Biến để theo dõi ô cell cuối cùng được click
    var lastClickedDate = null;
    // Biến để theo dõi số lần click
    var clickCount = 0;
    //  Biến calendar để lưu tạm
    var selectedDateFromFullCalendar; // Declare a global variable to store the selected date
    var mobiscrollInstanceSingleSelectDate;
    var mobiscrollInstanceMultiSelectDate;
    var mobiscrollInstanceSelectWeek;
    var mobiscrollInstanceSelectRangeDay;
    /*var countSanBong = parseInt([[${countNumber}]]);*/

    var thamSoTienCoc = parseInt([[${thamSoTienCoc}]]);

    var thoiGianDuocDatLich = parseInt([[${thoiGianDuocDatLich}]]);
    var timeoutId;
    var selectedValue = $("#selectLoaiSan").val();
    // Lấy ra table của
    var tableBody = document.querySelector("table.click-event-fullcalendar tbody");
    // Config FullCalendar
    document.addEventListener("DOMContentLoaded", function () {

        var calendarEl = document.getElementById("calendar");

        var dateViewStart = "";
        var dateViewEnd = "";
        calendar = new FullCalendar.Calendar(calendarEl, {
            selectable: true,
            headerToolbar: {
                left: "prev,next,today",
                center: "title",
                right: "dayGridMonth,timeGridWeek,timeGridDay",
            },
            /*datesSet: function (info) {
                dateViewStart = info.start;
                dateViewEnd = info.end;
                console.log(formatDate(dateViewStart));
                console.log(formatDate(dateViewEnd));
            },*/
            events: {
                url: "/api/vi/user/all-event?idLoaiSan=" + selectedValue,
                method: "GET",
                success: function (data) {
                    var eventDefaul = [];

                    for (var i = 0; i < data.length; i++) {
                        var sanBong = data[i];

                        // Parse the thoiGianDat value into a Date object
                        var thoiGianDat = new Date(sanBong.thoiGianDat);

                        var event = {
                            id: generateEventId(),
                            title: sanBong.tenCa,
                            start: new Date(
                                thoiGianDat.getFullYear(),
                                thoiGianDat.getMonth(),
                                thoiGianDat.getDate(),
                                parseInt(sanBong.thoiGianBatDau.split(":")[0]), // Giờ bắt đầu
                                parseInt(sanBong.thoiGianBatDau.split(":")[1]) // Phút bắt đầu
                            ),
                            end: new Date(
                                thoiGianDat.getFullYear(),
                                thoiGianDat.getMonth(),
                                thoiGianDat.getDate(),
                                parseInt(sanBong.thoiGianKetThuc.split(":")[0]), // Giờ kết thúc
                                parseInt(sanBong.thoiGianKetThuc.split(":")[1]) // Phút kết thúc
                            ),
                            allDay: false,
                            className: 'event-class-' + sanBong.trangThai,
                            extendedProps: {
                                trangThai: 'ORD-'+sanBong.trangThai,
                                classCustom: 'event-class-' + sanBong.trangThai,
                                giaSan: formatCurrencyVND(sanBong.gia),
                                idSanCa: sanBong.id,
                                soLanDoiLich:sanBong.soLanDoiLich,

                            },
                            /* editable: true,
                             idSanBong: sanBong.idSanBong,
                             gia: sanBong.gia,
                             trangThai: sanBong.trangThai,*/
                        };

                        eventDefaul.push(event);
                    }

                    // Add the events to the calendar
                    return eventDefaul;
                },
            },
            eventMouseEnter: function (info) {

                timeoutId = setTimeout(function () {
                    // Thực hiện hành động khi con trỏ chuột di chuyển qua một sự kiện
                    var event = info.event; // Lấy thông tin sự kiện

                    const startTimeVietnam = event.start.toLocaleTimeString("en-US", {
                        timeZone: "Asia/Ho_Chi_Minh",
                        hour: "2-digit",
                        minute: "2-digit",
                    });
                    const endTimeVietnam = event.end.toLocaleTimeString("en-US", {
                        timeZone: "Asia/Ho_Chi_Minh",
                        hour: "2-digit",
                        minute: "2-digit",
                    });

                    // Lấy ra ngày từ sự kiện
                    const dateVietnam = event.start.toLocaleDateString("en-US", {
                        timeZone: "Asia/Ho_Chi_Minh",
                        day: "2-digit",
                        month: "2-digit",
                        year: "numeric",
                    });

                    // Chuyển định dạng ngày tháng năm thành "dd - MM - yyyy"
                    const dateParts = dateVietnam.split("/");
                    const formattedDate =
                        dateParts[1] + "-" + dateParts[0] + "-" + dateParts[2];

                    const  trangThai = event.extendedProps.trangThai;

                    var tooltipHTML = '' +
                        '<div style="z-index: 7" class=" event-tooltip ' + event.extendedProps.classCustom + '">';

                    tooltipHTML += '<h3 style="color: #fff">' + event.title + '(' + formattedDate + ')' + '</h3>'; // Tiêu đề sự kiện
                    if(trangThai === 'NEW-FULL'){
                        tooltipHTML += '<small style="color: #fff">Lưu ý: Sân bóng đã có người đặt trước ' +
                            'quý khách vui lòng kéo ca này qua ngày khác để thực hiện đổi Ngày</small>'
                    }
                    if(trangThai === 'OVER-TIME'){
                        tooltipHTML += '<small style="color: #fff">Lưu ý: ca này đã ' +
                            'hết thời gian cho phép đặt. Quý khách vui lòng kéo ca này qua ngày khác để thực hiện đổi Ngày</small>'
                    }
                    tooltipHTML += '<hr/>';
                    tooltipHTML += '<p>' + 'Thời gian bắt đầu: ' + startTimeVietnam + '</p>'; // Ngày bắt đầu
                    tooltipHTML += '<p>' + 'Thời gian kết thúc: ' + endTimeVietnam + '</p>'; // Ngày kết thúc
                    tooltipHTML += '<p>' + 'Giá sân: ' + event.extendedProps.giaSan + '</p>'; // Mô tả

                    switch (trangThai) {
                        case "NEW":
                            tooltipHTML += '<p>' + 'Trạng thái: Tạo mới</p>'; // Mô tả
                            break
                        case "NEW-FULL":
                            tooltipHTML += '<p>' + 'Trạng thái: Đã có người đặt</p>'; // Mô tả
                            break
                        case "OVER-TIME":
                            tooltipHTML += '<p>' + 'Trạng thái: Hết thời gian đặt</p>'; // Mô tả
                            break
                        case "ORD-0":
                            tooltipHTML += '<p>' + 'Trạng thái: Chờ nhận sân</p>'; // Mô tả
                            break
                        case "ORD-1":
                            tooltipHTML += '<p>' + 'Trạng thái: Đang đá</p>'; // Mô tả
                            break
                        case "ORD-2":
                            tooltipHTML += '<p>' + 'Trạng thái: Chờ thanh toán</p>'; // Mô tả
                            break
                        case "ORD-3":
                            tooltipHTML += '<p>' + 'Trạng thái: Đã thanh toán</p>'; // Mô tả
                            break
                        case "ORD-4":
                            tooltipHTML += '<p>' + 'Trạng thái: Hủy sân</p>'; // Mô tả
                            break
                    }

                    tooltipHTML += '</div>';

                    // Hiển thị tooltip
                    var tooltipElement = document.createElement('div');
                    tooltipElement.innerHTML = tooltipHTML;
                    tooltipElement.style.position = 'absolute';
                    tooltipElement.style.left = info.jsEvent.pageX + 'px'; // Điều chỉnh khoảng cách bên phải
                    tooltipElement.style.top = info.jsEvent.pageY - tooltipElement.offsetHeight / 2 + 'px'; // Hiển thị bên phải

                    document.body.appendChild(tooltipElement);
                }, 500);

            },
            eventMouseLeave: function () {
                // Thực hiện hành động khi con trỏ chuột rời khỏi sự kiện
                clearTimeout(timeoutId);
                var tooltips = document.getElementsByClassName('event-tooltip');
                while (tooltips[0]) {
                    tooltips[0].parentNode.removeChild(tooltips[0]);
                }
            },
            eventDragStart: function () {
                // Ẩn và xóa tooltip khi bắt đầu kéo sự kiện
                var tooltips = document.getElementsByClassName('event-tooltip');
                while (tooltips[0]) {
                    tooltips[0].parentNode.removeChild(tooltips[0]);
                }
            },
            // Set the locale to Vietnamese
            locale: "vi",
            views: {
                dayGridMonth: {
                    // Customize the "dayGridMonth" view name
                    titleFormat: {year: "numeric", month: "long"},
                },
                timeGridWeek: {
                    // Customize the "timeGridWeek" view name
                    titleFormat: {year: "numeric", month: "short", day: "numeric"},
                },
                timeGridDay: {
                    // Customize the "timeGridDay" view name
                    titleFormat: {year: "numeric", month: "long", day: "numeric"},
                },
            },

            //sự kiện kéo qua ngày khác
            eventDrop: function (info) {
                clearTimeout(timeoutId);
                var tooltips = document.getElementsByClassName('event-tooltip');
                while (tooltips[0]) {
                    tooltips[0].parentNode.removeChild(tooltips[0]);
                }

                var eventDeful = calendar.getEventById(info.event.id);

                if(isPastDateTime(info.event.start)){
                    eventDeful.setProp('classNames', 'event-class-over-time');
                    eventDeful.setExtendedProp('trangThai', 'OVER-TIME');
                    eventDeful.setExtendedProp('classCustom', 'event-class-over-time');
                    var listCheck = [];
                    var eventsClickShowEvent = calendar.getEvents();
                    var eventsForSelectedDate = eventsClickShowEvent.filter(function (
                        event
                    ) {
                        return event.extendedProps.trangThai === 'NEW' || event.extendedProps.trangThai === 'NEW-FULL';
                    });

                    eventsForSelectedDate.forEach(value => {

                        var objectCheck = {};
                        objectCheck.id = value.id;
                        objectCheck.idLoaiSan = selectedValue;
                        objectCheck.idCa = value.extendedProps.idSanCa;
                        // Lấy ngày từ thời gian bắt đầu của sự kiện
                        const eventStart = new Date(value.start); // Chuyển đổi sang kiểu Date

                        const year = eventStart.getFullYear();
                        const month = eventStart.getMonth() + 1; // Tháng trong JavaScript bắt đầu từ 0, cần cộng thêm 1
                        const day = eventStart.getDate();

                        const formattedDate = `${year}-${month < 10 ? '0' + month : month}-${day < 10 ? '0' + day : day}`;

                        objectCheck.ngayDat = formattedDate;

                        listCheck.unshift(objectCheck);
                    })

                    $.ajax({
                        url: "/api/v1/user/san-ca/check-list-san-ca",
                        type: "POST",
                        data: JSON.stringify(listCheck),
                        contentType: "application/json",
                        success: function (data) {
                            debugger
                            for (const event of eventsForSelectedDate) {

                                const foundData = data.find(EExist => event.id === EExist.id);
                                if (foundData) {
                                    calendar.getEventById(event.id).setProp('classNames', 'event-class-full');
                                    calendar.getEventById(event.id).setExtendedProp('trangThai', 'NEW-FULL');
                                    calendar.getEventById(event.id).setExtendedProp('classCustom', 'event-class-full');
                                } else {
                                    calendar.getEventById(event.id).setProp('classNames', 'event-class');
                                    calendar.getEventById(event.id).setExtendedProp('trangThai', 'NEW');
                                    calendar.getEventById(event.id).setExtendedProp('classCustom', 'event-class');
                                }
                            }
                        },
                        error: function (error) {

                        }
                    });
                }else {

                    eventDeful.setProp('classNames', 'event-class');
                    eventDeful.setExtendedProp('trangThai', 'NEW');
                    eventDeful.setExtendedProp('classCustom', 'event-class');

                    var listCheck = [];
                    var eventsClickShowEvent = calendar.getEvents();
                    var eventsForSelectedDate = eventsClickShowEvent.filter(function (
                        event
                    ) {
                        return event.extendedProps.trangThai === 'NEW' || event.extendedProps.trangThai === 'NEW-FULL';
                    });

                    eventsForSelectedDate.forEach(value => {

                        var objectCheck = {};
                        objectCheck.id = value.id;
                        objectCheck.idLoaiSan = selectedValue;
                        objectCheck.idCa = value.extendedProps.idSanCa;
                        // Lấy ngày từ thời gian bắt đầu của sự kiện
                        const eventStart = new Date(value.start); // Chuyển đổi sang kiểu Date

                        const year = eventStart.getFullYear();
                        const month = eventStart.getMonth() + 1; // Tháng trong JavaScript bắt đầu từ 0, cần cộng thêm 1
                        const day = eventStart.getDate();

                        const formattedDate = `${year}-${month < 10 ? '0' + month : month}-${day < 10 ? '0' + day : day}`;

                        objectCheck.ngayDat = formattedDate;

                        listCheck.unshift(objectCheck);
                    })

                    $.ajax({
                        url: "/api/v1/user/san-ca/check-list-san-ca",
                        type: "POST",
                        data: JSON.stringify(listCheck),
                        contentType: "application/json",
                        success: function (data) {
                            debugger
                            for (const event of eventsForSelectedDate) {

                                const foundData = data.find(EExist => event.id === EExist.id);
                                if (foundData) {
                                    calendar.getEventById(event.id).setProp('classNames', 'event-class-full');
                                    calendar.getEventById(event.id).setExtendedProp('trangThai', 'NEW-FULL');
                                    calendar.getEventById(event.id).setExtendedProp('classCustom', 'event-class-full');
                                } else {
                                    calendar.getEventById(event.id).setProp('classNames', 'event-class');
                                    calendar.getEventById(event.id).setExtendedProp('trangThai', 'NEW');
                                    calendar.getEventById(event.id).setExtendedProp('classCustom', 'event-class');
                                }
                            }
                        },
                        error: function (error) {

                        }
                    });
                }




            },
            //  Config cho click vào cell day hiển thị modal
            dateClick: function (info) {

                var currentTime = new Date();
                currentTime.setDate(currentTime.getDate() - 1);

                // Lấy thời gian từ sự kiện click
                var clickTime = info.date;



                if (
                    lastClickedDate &&
                    info.date.getTime() !== lastClickedDate.getTime()
                ) {
                    // Kiểm tra nếu đã click vào ô cell khác, đặt lại clickCount thành 1
                    clickCount = 1;
                } else if (clickCount == 3) {
                    clickCount = 2;
                } else {
                    clickCount++;
                }
                // So sánh thời gian
                if (clickTime < currentTime) {
                    clickCount = 1
                }

                if (clickCount == 1) {

                    // hiện thị ca đã chọn
                    handleCalendarDateClick(info.date);
                    //
                    var selectDateClickShowEvent = info.date;
                    var eventsClickShowEvent = calendar.getEvents();

                    // Lọc sự kiện cho ngày được click
                    var eventsForSelectedDate = eventsClickShowEvent.filter(function (
                        event
                    ) {
                        return isSameDay(event.start, selectDateClickShowEvent);
                    });
                    // Hiển thị các sự kiện trong bảng
                    displayEventsInTable(eventsForSelectedDate);

                    //check
                    console.log("hiện thị ca đã chọn -Click count: " + clickCount);
                    // Click 1 lần đóng modal
                    closeModal1();
                } else if (clickCount == 2) {
                    selectedDateFromFullCalendar = info.date;

                    var cellElement = info.dayEl; // Lấy đối tượng DOM của ô cell đã click
                    var modal = document.getElementById("myModal1");

                    // Lấy ngày trong tuần của ô cell (0 là Chủ Nhật, 6 là Thứ Bảy)
                    var dayOfWeek = info.date.getDay();

                    // Lấy kích thước và vị trí của ô cell và modal
                    var cellRect = cellElement.getBoundingClientRect();
                    var modalRect = modal.getBoundingClientRect();

                    // LAMNP FIX MODAL RESULT LEFT ON 7, CN
                    // Điều chỉnh vị trí top và left của modal
                    var modalTop =
                        cellRect.top + cellRect.height / 2 - modalRect.height / 2;
                    var modalLeft = cellRect.left + cellRect.width;

                    // Kiểm tra xem cell có phải là Thứ 7 hoặc Chủ Nhật không
                    if (dayOfWeek === 0) {
                        // Nếu là Chủ Nhật, di chuyển sang trái 2 ngày
                        modalLeft -= cellRect.width * 5;
                    } else if (dayOfWeek === 6) {
                        // Nếu là Thứ Bảy, di chuyển sang trái 1 ngày
                        modalLeft -= cellRect.width * 5;
                    }

                    // LAMNP NODE : Nó đang ăn theo thằng thứ 7 và chủ nhật
                    // Thiết lập vị trí của modal
                    modal.style.top = modalTop - 15 + "px";
                    modal.style.left = modalLeft - 30 + "px";

                    // Cái này dùng để cố định modal khi di cuộn màn hình
                    // Triển làm
                    modal.style.position = "absolute";

                    // Đặt kích thước mặc định cho modal
                    modal.style.width = "auto";
                    modal.style.maxHeight = "auto";

                    // Hiển thị modal
                    /*modal.classList.add("visible");*/

                    addDataAndShowModal(modal, selectedValue);


                    // Đặt sự kiện để đóng modal khi người dùng click vào nút đóng (X)
                    document
                        .getElementById("closeModal1")
                        .addEventListener("click", function () {
                            modal.classList.remove("visible");
                        });
                    console.log(" hiện modal chọn ca-Click count: " + clickCount);
                } else {
                    // Click 3 lần đóng modal
                    closeModal1();
                    // Check
                    console.log("đóng modal -Click count: " + clickCount);
                }
                lastClickedDate = info.date;
            },
        });

        // Full calendar rendar
        calendar.render();

        document
            .getElementById("myModal1")
            .addEventListener("click", function () {
                if (lastClickedDate) {
                    // Chọn lại ô cell trước đó khi click trên modal
                    calendar.select(lastClickedDate);
                }
            });
    });

    function addDataAndShowModal(modal, idLoaiSan) {

        $.ajax({
            type: "GET",
            contentType: "application/json",
            url: "/api/v1/user/ca/get-all-ca?idLoaiSan=" + idLoaiSan,
            dataType: 'json',
            success: function (responseData) {
                $("#list").html(responseData.map(function (item) {
                        return ` <div class="col-md-4 col-12 mt-1">
                                <label class="checkbox-button">
                                    <input type="checkbox" class="custom-checkbox" value="${item.id}"/>
                                    <span class="checkbox-label">
                                      <strong>${item.tenCa + ' :'}</strong>
                                      <span>${item.thoiGianBatDau + ' - ' + item.thoiGianKetThuc}</span><br />
                                      <strong>Giá ca:</strong>
                                      <span>${formatCurrencyVND(item.giaSanCa)} </span><br />
                                      <div class="m-1">
                                            <strong>SL Sân:</strong>
                                          <input type="number" value="1" min="1" max="${item.countSanBong}"
                                               oninput="checkMaxValue(this,'${item.countSanBong}')" onblur="checkValue(this)"/>
                                      </div>
                                    </span>
                                </label>
                           </div>`
                    }
                ));
                modal.classList.add("visible");
            },
            error: function (e) {
                console.log("ERROR : ", e);
            }
        });
    }

    // LAMNP 17/10/2023, 20/10/2023 UPDATE
    // ADD sự kiện click vào cell day có ca hiển thị sang thông tin
    // Hàm để hiển thị các sự kiện trong bảng
    function displayEventsInTable(events) {
        // Xóa tất cả dữ liệu cũ trong bảng
        tableBody.innerHTML = "";
        // Thêm các sự kiện mới vào bảng
        events.forEach(function (event) {
            // Chuyển đổi một thời gian cụ thể sang múi giờ Việt Nam
            // Sử dụng múi giờ Việt Nam (GMT+7)
            const startTimeVietnam = event.start.toLocaleTimeString("en-US", {
                timeZone: "Asia/Ho_Chi_Minh",
                hour: "2-digit",
                minute: "2-digit",
            });
            const endTimeVietnam = event.end.toLocaleTimeString("en-US", {
                timeZone: "Asia/Ho_Chi_Minh",
                hour: "2-digit",
                minute: "2-digit",
            });

            // Lấy ra ngày từ sự kiện
            const dateVietnam = event.start.toLocaleDateString("en-US", {
                timeZone: "Asia/Ho_Chi_Minh",
                day: "2-digit",
                month: "2-digit",
                year: "numeric",
            });

            // Chuyển định dạng ngày tháng năm thành "dd - MM - yyyy"
            const dateParts = dateVietnam.split("/");
            const formattedDate =
                dateParts[1] + "-" + dateParts[0] + "-" + dateParts[2];

            addToTable(
                event.title,
                startTimeVietnam,
                endTimeVietnam,
                formattedDate,
                event.id,
                event.extendedProps.trangThai,
                event.extendedProps.idSanCa,
                event.extendedProps.soLanDoiLich
            );
        });
    }

    // Hàm để so sánh hai ngày xem chúng có cùng một ngày khôngs
    function isSameDay(date1, date2) {
        return (
            date1.getDate() === date2.getDate() &&
            date1.getMonth() === date2.getMonth() &&
            date1.getFullYear() === date2.getFullYear()
        );
    }


    // LAMNP 20/10/2023 UPDATE TABLE
    // Hàm để thêm thông tin ca vào bảng
    function addToTable(caInfo, timeStart, timeEnd, dateVietnam, eventId, statusEvent, idSanCa,soLanDoiLich) {
        // Create a row for the event information
        var rowInfo = tableBody.insertRow();
        var cell1 = rowInfo.insertCell(0);
        cell1.style.whiteSpace = "pre-line"; // Đặt white-space để hiển thị dòng mới
        cell1.textContent =
            caInfo +
            ": " +
            timeStart +
            " - " +
            timeEnd +
            "\n Ngày: " +
            dateVietnam ;



        // Sử dụng insertAdjacentHTML để thêm mã HTML
        var cell2 = rowInfo.insertCell(1);
        if (statusEvent === 'NEW') {
            cell2.insertAdjacentHTML(
                "beforeend",
                `
                    <div class="d-flex flex-column">
                      <button class="btn btn-danger btn-sm xoa-san-button" type="button" onclick="deleteEventById('` + eventId + `')">
                        Xóa
                      </button>
                    </div>
                  `
            );
        } else if (statusEvent === 'NEW-FULL') {
            cell2.insertAdjacentHTML(
                "beforeend",
                `
                    <div class="d-flex flex-column">
                      <button class="btn btn-warning btn-sm xoa-san-button" type="button" onclick="deleteEventById('` + eventId + `')">
                        Xóa
                      </button>
                    </div>
                  `
            );
        }else if (statusEvent === 'OVER-TIME') {
            cell2.insertAdjacentHTML(
                "beforeend",
                `
                    <div class="d-flex flex-column">
                      <button style="color: #fff;
                            background-color: #d35400;
                            border-color: #d35400; " class="btn btn-sm xoa-san-button"
                            type="button" onclick="deleteEventById('` + eventId + `')">
                        Xóa
                      </button>
                    </div>
                  `
            );
        }else if(statusEvent === 'ORD-0') {

            cell1.textContent += "\n Số lần đổi lịch: "+ soLanDoiLich;
            cell2.insertAdjacentHTML(
                "beforeend",
                `
                    <div class="d-flex flex-column">
                      <button class="btn btn-outline-danger btn-sm xoa-san-button " onclick="deleteLichSanBong('` + idSanCa + `')" type="button" >
                        Hủy lịch
                      </button>
                      <!-- Modal huy lich-->
                    <!-- Modal huy lich-->
                        <button class="btn btn-outline-primary btn-sm mt-2 doi-san-button"  type="button" onclick="doiSanDetail('` + idSanCa + `')">
                        Đổi sân
                        </button>
                    </div>
                `
                );
            }


        // Lấy các nút Chi Tiết và Đặt Sân bằng class
        var chiTietButton = cell2.querySelector(".xoa-san-button");
        var datSanButton = cell2.querySelector(".doi-san-button");

        /*// Thêm xử lý sự kiện cho nút Chi Tiết
        chiTietButton.addEventListener("click", function () {
        // Thực hiện xử lý khi nút Chi Tiết được nhấn
        // Ví dụ: Hiển thị thông tin chi tiết
        });

        // Thêm xử lý sự kiện cho nút Đặt Sân
        datSanButton.addEventListener("click", function () {

        });*/
    }

    //  LAMNP
    //  SET UP CALENDAR MOBISCROLL
    mobiscroll.setOptions({
        locale: mobiscroll.localeEn,
        theme: "material",
        themeVariant: "light",
    });

    // ADD EVENT CELL DAY
    document
        .getElementById("luuCaCellDay")
        .addEventListener("click", function () {
            // Click vào check box trước
            var checkboxes = document.querySelectorAll(".custom-checkbox");
            //
            var toastsArray = [];
            var events = [];
            var eventsOverTime = [];
            var selectComboboxDateChoise = document.getElementById("dateSelect");
            var emptyCheck = false;
            checkboxes.forEach(function (checkbox) {
                // Kiểm tra xem checkbox có được chọn (checked) hay không
                var checkboxButton = checkbox.parentElement;

                if (checkbox.checked) {
                    var checkboxValue = checkbox.value;
                    var inputElement = checkboxButton.querySelector(
                        "input[type='number']"
                    );
                    // Lấy content bên trong thẻ Strong
                    var caNameElement = checkboxButton.querySelector("strong");

                    // Lấy thông tin trong <span class="checkbox-label">
                    var strongElements = checkboxButton.querySelectorAll("strong");
                    var spanElements = checkboxButton.querySelectorAll("span");

                    // Lấy các thông tin cụ thể
                    var ca = strongElements[0].textContent; // Giá trị của "Ca 5:"
                    var thoiGian = spanElements[1].textContent; // Giá trị của "07:00 - 09:00"
                    var giaCa = spanElements[2].textContent; // Giá

                    // Sử dụng phương thức split() để tách chuỗi thành một mảng dựa trên dấu cách và gạch ngang
                    var parts = thoiGian.split(" - ");

                    // Lấy phần tử đầu tiên của mảng (07:00) và phần tử thứ hai của mảng (09:00)
                    var batDau = parts[0];
                    var ketThuc = parts[1];

                    //

                    if (caNameElement) {
                        // Lấy nội dung của phần tử `<strong>` (trong trường hợp này, "Ca 6")
                        var caName = caNameElement.textContent.split(":")[0];
                        // Lấy ra ngày chọn trong mobiscroll modal
                        var selectedDateMultiInModal =
                            $("#demo-multi-day").mobiscroll("getVal");
                        var selectedDateRangeInModal = $("#demo-range-selection").mobiscroll("getVal");

                        var selectedWeekInModal =
                            $("#demo-week-select").mobiscroll("getVal", "array");

                        //
                        if (selectComboboxDateChoise.value == 0) {
                            selectedDateMultiInModal.forEach(function (date) {
                                debugger
                                var day = date.getDate();
                                var month = date.getMonth();
                                var year = date.getFullYear();

                                //lấy tời gian được đặt lịch
                                var dateCheck= new Date(year,month,day,parseInt(batDau.split(":")[0]),parseInt(batDau.split(":")[1]));
                                dateCheck.setMinutes(dateCheck.getMinutes()- thoiGianDuocDatLich);

                                if(isPastDateTime(dateCheck)){
                                    // Tạo đối tượng sự kiện cho ngày này
                                    var event = {
                                        id: generateEventId(),
                                        title: caName,
                                        start: new Date(
                                            year,
                                            month,
                                            day,
                                            parseInt(batDau.split(":")[0]), // Giờ bắt đầu
                                            parseInt(batDau.split(":")[1]) // Phút bắt đầu
                                        ),
                                        end: new Date(
                                            year,
                                            month,
                                            day,
                                            parseInt(ketThuc.split(":")[0]), // Giờ kết thúc
                                            parseInt(ketThuc.split(":")[1]) // Phút kết thúc
                                        ),
                                        allDay: false, // Đặt thành false nếu bạn muốn sự kiện có thời gian cụ thể
                                        className: 'event-class-over-time',
                                        editable: true,
                                        extendedProps: {
                                            trangThai: 'OVER-TIME',
                                            classCustom: 'event-class-over-time',
                                            giaSan: giaCa,
                                            idSanCa: checkboxValue
                                        },
                                    };
                                    var element = parseInt(inputElement.value);
                                    console.log(element);
                                    for (let i = 0; i < element; i++) {
                                        var clonedEvent = {...event}; // Tạo bản sao của sự kiện ban đầu
                                        clonedEvent.id = generateEventId(); // Gán ID mới cho bản sao
                                        eventsOverTime.push(clonedEvent); // Thêm bản sao với ID mới vào mảng events
                                        var error = ["bg-warning", "Thông báo",event.title +" Ngày: "+day+"/"+month+"/"+year
                                        +" đã hết thời gian cho phép đặt lịch"];
                                        toastsArray.push(error);
                                    }
                                }else {
                                    // Tạo đối tượng sự kiện cho ngày này
                                    var event = {
                                        id: generateEventId(),
                                        title: caName,
                                        start: new Date(
                                            year,
                                            month,
                                            day,
                                            parseInt(batDau.split(":")[0]), // Giờ bắt đầu
                                            parseInt(batDau.split(":")[1]) // Phút bắt đầu
                                        ),
                                        end: new Date(
                                            year,
                                            month,
                                            day,
                                            parseInt(ketThuc.split(":")[0]), // Giờ kết thúc
                                            parseInt(ketThuc.split(":")[1]) // Phút kết thúc
                                        ),
                                        allDay: false, // Đặt thành false nếu bạn muốn sự kiện có thời gian cụ thể
                                        className: 'event-class',
                                        editable: true,
                                        extendedProps: {
                                            trangThai: 'NEW',
                                            classCustom: 'event-class',
                                            giaSan: giaCa,
                                            idSanCa: checkboxValue
                                        },
                                    };
                                    var element = parseInt(inputElement.value);
                                    console.log(element);
                                    for (let i = 0; i < element; i++) {
                                        var clonedEvent = {...event}; // Tạo bản sao của sự kiện ban đầu
                                        clonedEvent.id = generateEventId(); // Gán ID mới cho bản sao
                                        events.push(clonedEvent); // Thêm bản sao với ID mới vào mảng events
                                    }
                                }

                            });
                        } else if (selectComboboxDateChoise.value == 1) {

                            var startDate = new Date(selectedDateRangeInModal[0]); // Ngày bắt đầu
                            var endDate = new Date(selectedDateRangeInModal[1]);   // Ngày kết thúc

                            var dateArray = [];

                            var currentDate = startDate;
                            while (currentDate <= endDate) {
                                dateArray.push(new Date(currentDate));
                                currentDate.setDate(currentDate.getDate() + 1);
                            }
                            dateArray.forEach(function (date) {
                                var day = date.getDate();
                                var month = date.getMonth();
                                var year = date.getFullYear();
                                var dateCheck= new Date(year,month,day,parseInt(batDau.split(":")[0]),parseInt(batDau.split(":")[1]));
                                dateCheck.setMinutes(dateCheck.getMinutes()- thoiGianDuocDatLich);

                                if(isPastDateTime(dateCheck)){
                                    // Tạo đối tượng sự kiện cho ngày này
                                    var event = {
                                        id: generateEventId(),
                                        title: caName,
                                        start: new Date(
                                            year,
                                            month,
                                            day,
                                            batDau.split(":")[0],
                                            batDau.split(":")[1]
                                        ), // Thêm giờ bắt đầu và phút bắt đầu
                                        end: new Date(
                                            year,
                                            month,
                                            day,
                                            ketThuc.split(":")[0],
                                            ketThuc.split(":")[1]
                                        ), // Thêm giờ kết thúc và phút kết thúc
                                        allDay: false, // Đặt thành false nếu bạn muốn sự kiện có thời gian cụ thể
                                        className: 'event-class-over-time',
                                        editable: true,
                                        extendedProps: {
                                            trangThai: 'OVER-TIME',
                                            classCustom: 'event-class-over-time',
                                            giaSan: giaCa,
                                            idSanCa: checkboxValue
                                        },
                                    };
                                    var element = parseInt(inputElement.value);

                                    for (let i = 0; i < element; i++) {
                                        var clonedEvent = {...event}; // Tạo bản sao của sự kiện ban đầu
                                        clonedEvent.id = generateEventId(); // Gán ID mới cho bản sao
                                        eventsOverTime.push(clonedEvent); // Thêm bản sao với ID mới vào mảng events
                                        var error = ["bg-warning", "Thông báo",event.title +" Ngày: "+day+"/"+month+"/"+year
                                        +" đã hết thời gian cho phép đặt lịch"];
                                        toastsArray.push(error);
                                    }
                                }else {
                                    // Tạo đối tượng sự kiện cho ngày này
                                    var event = {
                                        id: generateEventId(),
                                        title: caName,
                                        start: new Date(
                                            year,
                                            month,
                                            day,
                                            batDau.split(":")[0],
                                            batDau.split(":")[1]
                                        ), // Thêm giờ bắt đầu và phút bắt đầu
                                        end: new Date(
                                            year,
                                            month,
                                            day,
                                            ketThuc.split(":")[0],
                                            ketThuc.split(":")[1]
                                        ), // Thêm giờ kết thúc và phút kết thúc
                                        allDay: false, // Đặt thành false nếu bạn muốn sự kiện có thời gian cụ thể
                                        className: 'event-class',
                                        editable: true,
                                        extendedProps: {
                                            trangThai: 'NEW',
                                            classCustom: 'event-class',
                                            giaSan: giaCa,
                                            idSanCa: checkboxValue
                                        },
                                    };
                                    var element = parseInt(inputElement.value);

                                    for (let i = 0; i < element; i++) {
                                        var clonedEvent = {...event}; // Tạo bản sao của sự kiện ban đầu
                                        clonedEvent.id = generateEventId(); // Gán ID mới cho bản sao
                                        events.push(clonedEvent); // Thêm bản sao với ID mới vào mảng events
                                    }
                                }
                            });
                        } else if (selectComboboxDateChoise.value == 2) {
                            var startDate = new Date(selectedWeekInModal[0]); // Ngày bắt đầu
                            var endDate = new Date(selectedWeekInModal[1]);   // Ngày kết thúc

                            var dateArray = [];

                            var currentDate = startDate;
                            while (currentDate <= endDate) {
                                dateArray.push(new Date(currentDate));
                                currentDate.setDate(currentDate.getDate() + 1);
                            }

                            dateArray.forEach(function (date) {
                                var day = date.getDate();
                                var month = date.getMonth();
                                var year = date.getFullYear();

                                var dateCheck= new Date(year,month,day,parseInt(batDau.split(":")[0]),parseInt(batDau.split(":")[1]));
                                dateCheck.setMinutes(dateCheck.getMinutes()- thoiGianDuocDatLich);

                                if(isPastDateTime(dateCheck)){
                                    // Tạo đối tượng sự kiện cho ngày này
                                    var event = {
                                        id: generateEventId(),
                                        title: caName,
                                        start: new Date(
                                            year,
                                            month,
                                            day,
                                            batDau.split(":")[0],
                                            batDau.split(":")[1]
                                        ), // Thêm giờ bắt đầu và phút bắt đầu
                                        end: new Date(
                                            year,
                                            month,
                                            day,
                                            ketThuc.split(":")[0],
                                            ketThuc.split(":")[1]
                                        ), // Thêm giờ kết thúc và phút kết thúc
                                        allDay: false, // Đặt thành false nếu bạn muốn sự kiện có thời gian cụ thể
                                        className: 'event-class-over-time',
                                        editable: true,
                                        extendedProps: {
                                            trangThai: 'OVER-TIME',
                                            classCustom: 'event-class-over-time',
                                            giaSan: giaCa,
                                            idSanCa: checkboxValue
                                        },
                                    };
                                    var element = parseInt(inputElement.value);
                                    console.log(element);
                                    for (let i = 0; i < element; i++) {
                                        var clonedEvent = {...event}; // Tạo bản sao của sự kiện ban đầu
                                        clonedEvent.id = generateEventId(); // Gán ID mới cho bản sao
                                        eventsOverTime.push(clonedEvent); // Thêm bản sao với ID mới vào mảng events
                                        var error = ["bg-warning", "Thông báo",event.title +" Ngày: "+day+"/"+month+"/"+year
                                        +" đã hết thời gian cho phép đặt lịch"];
                                        toastsArray.push(error);
                                    }
                                }else {
                                    // Tạo đối tượng sự kiện cho ngày này
                                    var event = {
                                        id: generateEventId(),
                                        title: caName,
                                        start: new Date(
                                            year,
                                            month,
                                            day,
                                            batDau.split(":")[0],
                                            batDau.split(":")[1]
                                        ), // Thêm giờ bắt đầu và phút bắt đầu
                                        end: new Date(
                                            year,
                                            month,
                                            day,
                                            ketThuc.split(":")[0],
                                            ketThuc.split(":")[1]
                                        ), // Thêm giờ kết thúc và phút kết thúc
                                        allDay: false, // Đặt thành false nếu bạn muốn sự kiện có thời gian cụ thể
                                        className: 'event-class',
                                        editable: true,
                                        extendedProps: {
                                            trangThai: 'NEW',
                                            classCustom: 'event-class',
                                            giaSan: giaCa,
                                            idSanCa: checkboxValue
                                        },
                                    };
                                    var element = parseInt(inputElement.value);
                                    console.log(element);
                                    for (let i = 0; i < element; i++) {
                                        var clonedEvent = {...event}; // Tạo bản sao của sự kiện ban đầu
                                        clonedEvent.id = generateEventId(); // Gán ID mới cho bản sao
                                        events.push(clonedEvent); // Thêm bản sao với ID mới vào mảng events
                                    }
                                }



                            });
                        }


                        closeModal1();
                        emptyCheck = true;
                    }

                }
            });
            if(!emptyCheck){
                createAndShowToast("bg-warning", "Thông báo", "Vui lòng chọn ca muốn đặt sân bóng!");
            }
            var listCheck = [];
            events.forEach(value => {

                var objectCheck = {};
                objectCheck.id = value.id;
                objectCheck.idLoaiSan = selectedValue;
                objectCheck.idCa = value.extendedProps.idSanCa;
                const eventStart = new Date(value.start); // Chuyển đổi sang kiểu Date

                const year = eventStart.getFullYear();
                const month = eventStart.getMonth() + 1; // Tháng trong JavaScript bắt đầu từ 0, cần cộng thêm 1
                const day = eventStart.getDate();

                const formattedDate = `${year}-${month < 10 ? '0' + month : month}-${day < 10 ? '0' + day : day}`;
                objectCheck.ngayDat = formattedDate;

                listCheck.push(objectCheck);
            })

            var eventsClickShowEvent = calendar.getEvents();
            var eventsForSelectedDate = eventsClickShowEvent.filter(function (
                event
            ) {
                return event.extendedProps.trangThai === 'NEW' || event.extendedProps.trangThai === 'NEW-FULL';
            });

            eventsForSelectedDate.forEach(value => {

                var objectCheck = {};
                objectCheck.id = value.id;
                objectCheck.idLoaiSan = selectedValue;
                objectCheck.idCa = value.extendedProps.idSanCa;
                // Lấy ngày từ thời gian bắt đầu của sự kiện
                const eventStart = new Date(value.start); // Chuyển đổi sang kiểu Date

                const year = eventStart.getFullYear();
                const month = eventStart.getMonth() + 1; // Tháng trong JavaScript bắt đầu từ 0, cần cộng thêm 1
                const day = eventStart.getDate();

                const formattedDate = `${year}-${month < 10 ? '0' + month : month}-${day < 10 ? '0' + day : day}`;

                objectCheck.ngayDat = formattedDate;

                listCheck.unshift(objectCheck);
            })

            $.ajax({
                url: "/api/v1/user/san-ca/check-list-san-ca",
                type: "POST",
                data: JSON.stringify(listCheck),
                contentType: "application/json",
                success: function (data) {

                    if (data.length > 0 || data != '') {
                         //     ["bg-success", "Error 1", "Description 1"],
                        data.forEach(EExist => {
                            const foundEvent = events.find(event => event.id === EExist.id);
                            if (foundEvent) {
                                // Tạo bản sao của extendedProps
                                const updatedExtendedProps = {...foundEvent.extendedProps};
                                // Cập nhật thuộc tính mới cho bản sao
                                updatedExtendedProps.trangThai = 'NEW-FULL';
                                updatedExtendedProps.classCustom = 'event-class-full';
                                // Gán extendedProps của sự kiện bằng bản sao đã cập nhật
                                foundEvent.extendedProps = updatedExtendedProps;
                                foundEvent.className = 'event-class-full';

                                const eventStart = new Date(foundEvent.start); // Chuyển đổi sang kiểu Date

                                const year = eventStart.getFullYear();
                                const month = eventStart.getMonth() + 1; // Tháng trong JavaScript bắt đầu từ 0, cần cộng thêm 1
                                const day = eventStart.getDate();

                                const formattedDate = `${day < 10 ? '0' + day : day}/${month < 10 ? '0' + month : month}/${year}`;
                                var error = ["bg-warning", "Thông báo", foundEvent.title + " của ngày " +
                                formattedDate + " hiện tại đã có người đặt. Vui lòng kiểm tra lại"];
                                toastsArray.push(error);
                            }
                        });
                        calendar.addEventSource(eventsOverTime);
                        calendar.addEventSource(events);
                        // Thêm sự kiện vào FullCalendar
                        calendar.render();
                        createMultipleToasts(toastsArray);


                    } else {
                        calendar.addEventSource(eventsOverTime);
                        calendar.addEventSource(events);
                        // Thêm sự kiện vào FullCalendar
                        calendar.render(); // Cập nhật lịch sau khi thêm sự kiện
                        createMultipleToasts(toastsArray);
                    }
                    var selectDateClickShowEvent = lastClickedDate;
                    var eventsClickShowEvent = calendar.getEvents();

                    // Lọc sự kiện cho ngày được click
                    var eventsForSelectedDate = eventsClickShowEvent.filter(function (
                        event
                    ) {
                        return isSameDay(event.start, selectDateClickShowEvent);
                    });
                    // Hiển thị các sự kiện trong bảng
                    displayEventsInTable(eventsForSelectedDate);
                },
                error: function (error) {

                }
            });

        });

    $(function () {
        // MULTI
        $("#demo-multi-day")
            .mobiscroll()
            .datepicker({
                controls: ["calendar"],
                display: "inline",
                selectMultiple: true,
                min: new Date(),
            });

        // COUNTER
        $("#demo-range-selection")
            .mobiscroll()
            .datepicker({
                controls: ["calendar"], // More info about controls: https://docs.mobiscroll.com/5-27-1/calendar#opt-controls
                display: "inline", // Specify display mode like: display: 'bottom' or omit setting to use default
                rangeSelectMode: "wizard",
                select: "range", // More info about select: https://docs.mobiscroll.com/5-27-1/calendar#opt-select
                showRangeLabels: true,
                min: new Date(),
            });

        // SINGLE
        $("#demo-single-select-date")
            .mobiscroll()
            .datepicker({
                controls: ["calendar"],
                display: "inline",
                selectMultiple: false,
            });

        //  WEEK
        $("#demo-week-select")
            .mobiscroll()
            .datepicker({
                controls: ["calendar"],
                select: "preset-range",
                display: "inline",
                // firstSelectDay: 1,
                selectSize: 14,
                min: new Date(),
            });
    });

    $(function () {
        $("#demo-single-select-date")
            .mobiscroll()
            .datepicker({
                controls: ["calendar"],
                display: "inline",
                locale: mobiscroll.localeVi,
                onChange: function (event, inst) {
                    var selectedDate = inst.getVal();
                    var year = selectedDate.getFullYear();
                    var month = selectedDate.getMonth(); // Tháng bắt đầu từ 0
                    var day = selectedDate.getDate();

                    var newDate = new Date(year, month, day);
                    //chọn ngày trên lịch nhỏ Đặt ngày trên FullCalendar
                    var eventsClickShowEvent = calendar.getEvents();

                    // Lọc sự kiện cho ngày được click
                    var eventsForSelectedDate = eventsClickShowEvent.filter(function (
                        event
                    ) {
                        return isSameDay(event.start, newDate);
                    });
                    // Hiển thị các sự kiện trong bảng
                    displayEventsInTable(eventsForSelectedDate);
                    calendar.gotoDate(newDate);
                    calendar.select(newDate);
                },
            });
        mobiscrollInstanceSingleSelectDate = $(
            "#demo-single-select-date"
        ).mobiscroll("getInst");
        // Từ Ful Calendar sang modal
        mobiscrollInstanceMultiSelectDate =
            $("#demo-multi-day").mobiscroll("getInst");
        mobiscrollInstanceSelectWeek =
            $("#demo-week-select").mobiscroll("getInst");
        mobiscrollInstanceSelectRangeDay = $(
            "#demo-range-selection"
        ).mobiscroll("getInst");
    });

    // Hàm chọn từ Fulcalendar -> lịch bé
    function handleCalendarDateClick(selectedDate) {
        mobiscrollInstanceSingleSelectDate.setVal(selectedDate);
        mobiscrollInstanceMultiSelectDate.setVal(selectedDate);
        mobiscrollInstanceSelectWeek.setVal(selectedDate);
        mobiscrollInstanceSelectRangeDay.setVal(selectedDate);
    }

    // LAMNP 14/10/2023
    // SỬ LÝ SỰ KIỆN SHOW LỊCH KHI CUS CHỌN ĐẶT LỊCH THEO NGÀY, TUẦN, THÁNG
    // Lấy tham chiếu đến select và các div cần ẩn/hiển thị
    var dateSelect = document.getElementById("dateSelect");
    // Select type choise clendar
    var demoMultiDay = document.getElementById("demo-multi-day");
    var demoRange = document.getElementById("demo-range-selection");
    var demoWeek = document.getElementById("demo-week-select");

    // Ẩn mặc định hai calendar
    demoRange.style.display = "none";
    demoWeek.style.display = "none";

    // Gắn sự kiện change cho select
    dateSelect.addEventListener("change", function () {
        // Lấy giá trị được chọn trong select
        var selectedValue = dateSelect.value;

        // Ẩn tất cả các div trước
        demoMultiDay.style.display = "none";
        demoRange.style.display = "none";
        demoWeek.style.display = "none";

        // Hiển thị div tương ứng dựa trên giá trị được chọn
        if (selectedValue === "0") {
            demoMultiDay.style.display = "block";
        } else if (selectedValue === "1") {
            demoRange.style.display = "block";
        } else if (selectedValue === "2") {
            demoWeek.style.display = "block";
        }
    });

    // LAMNP 14/10/2023
    // hàm dùng chung đóng modal
    function closeModal1() {
        var modal = document.getElementById("myModal1");
        modal.classList.remove("visible");
    }

    function checkMaxValue(inputElement, countSanBong) {

        var countNumber = parseInt(countSanBong);
        var inputValue = parseInt(inputElement.value);

        if (inputValue > countNumber) {
            inputElement.value = countNumber;
        } else {
            inputElement.value = inputElement.value;
        }
    }

    function checkValue(inputElement) {
        var inputValue = parseInt(inputElement.value);

        if (isNaN(inputValue) || inputValue < 1) {
            inputElement.value = 1;
        }
    }

    function showModalInfo() {

        var eventNew = getEventNew();

        if (eventNew.length > 0) {
            addDateToFormDatLich(eventNew);
            $('#modalInfo').modal('show');
        } else {
            createAndShowToast("bg-warning", "Thông báo", "Vui lòng chọn Ca và Ngày đá");
        }

    }


    function getEventNew() {

        var eventsClickShowEvent = calendar.getEvents();

        // Lọc sự kiện cho ngày được click
        var eventsForSelectedDate = eventsClickShowEvent.filter(function (
            event
        ) {
            return event.extendedProps.trangThai === 'NEW';
        });
        return eventsForSelectedDate;
    }

    // Hàm để tạo ID ngẫu nhiên
    function generateEventId() {
        // Sử dụng timestamp và một số ngẫu nhiên để tạo ID độc đáo
        return 'event_' + new Date().getTime() + '_' + Math.floor(Math.random() * 1000000);
    }

    // Hàm để lấy danh sách sự kiện dựa trên ID loại sân
    function findEventByLoaiSan(idLoaiSan) {
        return fetch("/api/vi/user/all-event?idLoaiSan=" + idLoaiSan, {
            method: "GET",
        })
            .then(function (response) {
                if (!response.ok) {
                    throw new Error('Lỗi khi lấy dữ liệu');
                }
                return response.json();
            })
            .then(function (data) {
                var eventDefaul = [];

                for (var i = 0; i < data.length; i++) {
                    var sanBong = data[i];

                    // Parse dữ liệu và tạo sự kiện
                    var thoiGianDat = new Date(sanBong.thoiGianDat);
                    var event = {
                        id: generateEventId(),
                        title: sanBong.tenCa,
                        start: new Date(
                            thoiGianDat.getFullYear(),
                            thoiGianDat.getMonth(),
                            thoiGianDat.getDate(),
                            parseInt(sanBong.thoiGianBatDau.split(":")[0]),
                            parseInt(sanBong.thoiGianBatDau.split(":")[1])
                        ),
                        end: new Date(
                            thoiGianDat.getFullYear(),
                            thoiGianDat.getMonth(),
                            thoiGianDat.getDate(),
                            parseInt(sanBong.thoiGianKetThuc.split(":")[0]),
                            parseInt(sanBong.thoiGianKetThuc.split(":")[1])
                        ),
                        allDay: false,
                        className: 'event-class-' + sanBong.trangThai,
                        extendedProps: {
                            trangThai: 'ORD-'+sanBong.trangThai,
                            classCustom: 'event-class-' + sanBong.trangThai,
                            giaSan: formatCurrencyVND(sanBong.gia),
                            idSanCa: sanBong.id,
                            soLanDoiLich:sanBong.soLanDoiLich,
                        },
                    };

                    eventDefaul.push(event);
                }

                return eventDefaul;
            });
    }

    function resetEventByIdLoaiSan(idLoaiSan) {
        $('#tableShow').html('');
        selectedValue = idLoaiSan;
        calendar.removeAllEvents();

        findEventByLoaiSan(idLoaiSan)
            .then(function (events) {
                calendar.addEventSource(events);
                calendar.render();
            })
            .catch(function (error) {
                console.error(error);
            });
    }

    function deleteEventById(eventId) {

        var event = calendar.getEventById(eventId); // Lấy sự kiện dựa trên eventId
        if (event) {
            event.remove(); // Xóa sự kiện
            var eventNew = getEventNew();
            if (eventNew.length > 0) {
                addDateToFormDatLich(eventNew);
            } else {
                $('#modalInfo').modal('hide');
            }

            var listCheck = [];
            var eventsClickShowEvent = calendar.getEvents();
            var eventsForSelectedDate = eventsClickShowEvent.filter(function (
                event
            ) {
                return event.extendedProps.trangThai === 'NEW' || event.extendedProps.trangThai === 'NEW-FULL';
            });

            eventsForSelectedDate.forEach(value => {

                var objectCheck = {};
                objectCheck.id = value.id;
                objectCheck.idLoaiSan = selectedValue;
                objectCheck.idCa = value.extendedProps.idSanCa;
                // Lấy ngày từ thời gian bắt đầu của sự kiện
                const eventStart = new Date(value.start); // Chuyển đổi sang kiểu Date

                const year = eventStart.getFullYear();
                const month = eventStart.getMonth() + 1; // Tháng trong JavaScript bắt đầu từ 0, cần cộng thêm 1
                const day = eventStart.getDate();

                const formattedDate = `${year}-${month < 10 ? '0' + month : month}-${day < 10 ? '0' + day : day}`;

                objectCheck.ngayDat = formattedDate;

                listCheck.unshift(objectCheck);
            })

            $.ajax({
                url: "/api/v1/user/san-ca/check-list-san-ca",
                type: "POST",
                data: JSON.stringify(listCheck),
                contentType: "application/json",
                success: function (data) {
                    for (const event of eventsForSelectedDate) {

                        const foundData = data.find(EExist => event.id === EExist.id);
                        if (foundData) {
                            calendar.getEventById(event.id).setProp('classNames', 'event-class-full');
                            calendar.getEventById(event.id).setExtendedProp('trangThai', 'NEW-FULL');
                            calendar.getEventById(event.id).setExtendedProp('classCustom', 'event-class-full');
                        } else {
                            calendar.getEventById(event.id).setProp('classNames', 'event-class');
                            calendar.getEventById(event.id).setExtendedProp('trangThai', 'NEW');
                            calendar.getEventById(event.id).setExtendedProp('classCustom', 'event-class');
                        }
                    }
                    var selectDateClickShowEvent = event.start;
                    var eventsClickShowEvent = calendar.getEvents();

                    // Lọc sự kiện cho ngày được click
                    var eventsForSelectedDate2 = eventsClickShowEvent.filter(function (
                        event
                    ) {
                        return isSameDay(event.start, selectDateClickShowEvent);
                    });
                    // Hiển thị các sự kiện trong bảng
                    displayEventsInTable(eventsForSelectedDate2);
                },
                error: function (error) {

                }
            });
        }
    }
    function xacNhanDatLich() {
        Swal.fire({
            title: "Quý khách có chắc chắn đặt lịch và thanh toán?",
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Xác nhận',
        }).then((result) => {
            if (result.isConfirmed) {
                getFormLichDat()
            }
        });
    }

    function getFormLichDat() {

        var selectedValue = $("#selectLoaiSan").val();
        var hoVaTen = $('#hoVaTen').val();
        var sdt = $('#sdt').val();
        var mail = $('#mail').val();
        var remark = $('#remark').val();
        var check = false;

        if (hoVaTen.trim() == '') {
            $('#hoVaTen_erro').text("Vui lòng nhập họ và tên");
            check = true;
        }else {
            $('#hoVaTen_erro').text("");
        }
        const regexSDT = /^(84|\+84|0)(3[2-9]|5[689]|7[06-9]|8[1-9]|9[0-9])[0-9]{7}$/;
        if (sdt.trim() == '') {
            $('#sdt_erro').text("Vui lòng nhập số điện thoại");
            check = true;
        }else if (!regexSDT.test(sdt)) {
            $('#sdt_erro').text("Vui lòng nhập số điện thoại đúng định dạng");
            check = true;
        }else {
            $('#sdt_erro').text("");
        }
        const regexEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (mail.trim() == '') {
            $('#mail_erro').text("Vui lòng nhập email");
            check = true;
        }else if (!regexEmail.test(mail)) {
            $('#mail_erro').text("Vui lòng nhập email đúng định dạng");
            return true;
        }else {
            $('#mail_erro').text("");
        }

        if (check) {
            return;
        }

        // Lấy danh sách các hàng (tr) trong bảng
        var rows = document.querySelectorAll("#myTable tbody tr");

        var tableData = [];

        // Bắt đầu từ hàng thứ 1 (hàng đầu tiên là tiêu đề)
        rows.forEach(function (row, index) {
            if (index !== 0) {

                var idCa = row.getAttribute("data-id");
                var cells = row.querySelectorAll("td");

                var dataObject = {};

                dataObject.ngayDa = cells[1].textContent;
                dataObject.giaSan = cutMoney(cells[2].textContent);
                dataObject.idCa = idCa;

                tableData.push(dataObject);
            }
        });

        debugger
        var tongTienSan = chuyenTienTeSangSo($('#id_tongTien').text());

        var formDatLich = {
            hoVaTen: hoVaTen,
            email: mail,
            tongTienSan: cutMoney(tongTienSan),
            sdt: sdt,
            ghiChu: remark,
            idLoaiSan: selectedValue,
            danhSachCaDatRequests: tableData
        }

        $.ajax({
            url: "/api/v1/user/dat-lich/form-dat-lich",
            type: "POST",
            data: JSON.stringify(formDatLich),
            contentType: "application/json",
            success: function (data) {
                debugger
                $('#modalInfo').modal('hide');
                /*alert(data.content);
                resetEventByIdLoaiSan(selectedValue);*/
                if (data.statusCode == 'OK') {
                    // Tạo form ẩn
                    var form = $('<form action="/api/v1/user/thanh-toan/create-payment" method="post"></form>');
                    form.append('<input type="hidden" name="HDrequest" value=\'' + JSON.stringify(data.content) + '\' />');
                    $('body').append(form);

                    // Submit form để chuyển hướng
                    form.submit();
                } else {
                    createAndShowToast(" bg-danger", "Thông báo", data.content);
                }

            },
            error: function (error) {
                $('#modalInfo').modal('hide');
                alert(error.responseJSON.message);
            }
        });
    }

    function cutMoney(chuoi) {

        chuoi = chuoi.toString();

        // Remove all non-numeric characters, except for decimal points, plus and minus signs
        chuoi = chuoi.replace(/[^0-9]/g, '');

        // Parse the string into a number
        chuoi = parseFloat(chuoi);
        if (chuoi !== null) {
            return chuoi;
        } else {

            console.log("Không tìm thấy số tiền trong chuỗi.");
            return 0;
        }
    }

    function formatDate(date) {
        var day = date.getDate();
        var month = date.getMonth() + 1;
        var year = date.getFullYear();
        return (day < 10 ? '0' : '') + day + '/' + (month < 10 ? '0' : '') + month + '/' + year;
    }

    $(document).ready(function () {
        $(document).on("click", ".add-row", function () {

            const caSelect = document.querySelector('#selectCaDatLichs');
            const datePicker = document.querySelector('#datepicker');
            const selectedCa = caSelect.options[caSelect.selectedIndex].value;
            const selectedDate = datePicker.value;

            if (selectedCa == '' && selectedDate == '') {
                createAndShowToast("bg-warning", "Thông báo", "Vui lòng chọn ca và ngày đặt sân");
                return;
            }
            if (selectedCa == '') {

                createAndShowToast("bg-warning", "Thông báo", "Vui lòng chọn ca muốn đặt");
                return;
            }
            if (selectedDate == '') {
                createAndShowToast("bg-warning", "Thông báo", "Vui lòng chọn ngày muốn đặt");
                return;
            }

            var listCheck = [];

            var objectCheck = {};
            objectCheck.idLoaiSan = selectedValue;
            objectCheck.idCa = selectedCa;
            objectCheck.ngayDat = selectedDate;
            listCheck.push(objectCheck);

            var eventsClickShowEvent = calendar.getEvents();
            var eventsForSelectedDate = eventsClickShowEvent.filter(function (
                event
            ) {
                return event.extendedProps.trangThai === 'NEW';
            });

            eventsForSelectedDate.forEach(value => {

                var objectCheck = {};
                objectCheck.id = value.id;
                objectCheck.idLoaiSan = selectedValue;
                objectCheck.idCa = value.extendedProps.idSanCa;
                // Lấy ngày từ thời gian bắt đầu của sự kiện
                const eventStart = new Date(value.start); // Chuyển đổi sang kiểu Date

                const year = eventStart.getFullYear();
                const month = eventStart.getMonth() + 1; // Tháng trong JavaScript bắt đầu từ 0, cần cộng thêm 1
                const day = eventStart.getDate();

                const formattedDate = `${year}-${month < 10 ? '0' + month : month}-${day < 10 ? '0' + day : day}`;

                objectCheck.ngayDat = formattedDate;

                listCheck.unshift(objectCheck);
            })


            $.ajax({
                type: "POST",
                contentType: "application/json",
                url: "/api/v1/user/san-ca/check-list-san-ca",
                data: JSON.stringify(listCheck),
                dataType: 'json',
                success: function (responseData) {
                    debugger
                    if (responseData.length <= 0 || responseData == '') {
                        $.ajax({
                            type: "GET",
                            contentType: "application/json",
                            url: "/api/v1/user/ca/get-info-ca?idLoaiSan=" + selectedValue + "&&idCa=" + selectedCa,
                            dataType: 'json',
                            success: function (data) {
                                var sanBong = data;
                                var thoiGianDat = new Date(selectedDate);
                                var dateCheck=  new Date(thoiGianDat.getFullYear(),thoiGianDat.getMonth(),thoiGianDat.getDate(),parseInt(sanBong.thoiGianBatDau.split(":")[0]),
                                    parseInt(sanBong.thoiGianBatDau.split(":")[1])
                                );
                                if(isPastDateTime(dateCheck)){
                                    createAndShowToast("bg-warning", "Thông báo", sanBong.tenCa +' Ngày: '+
                                        thoiGianDat.getDate()+'/'+thoiGianDat.getMonth()+'/'+thoiGianDat.getFullYear()+' đã hết thời gian cho ' +
                                        'phép đặt lịch.');
                                }else {
                                    var event = {
                                        id: generateEventId(),
                                        title: sanBong.tenCa,
                                        start: new Date(
                                            thoiGianDat.getFullYear(),
                                            thoiGianDat.getMonth(),
                                            thoiGianDat.getDate(),
                                            parseInt(sanBong.thoiGianBatDau.split(":")[0]),
                                            parseInt(sanBong.thoiGianBatDau.split(":")[1])
                                        ),
                                        end: new Date(
                                            thoiGianDat.getFullYear(),
                                            thoiGianDat.getMonth(),
                                            thoiGianDat.getDate(),
                                            parseInt(sanBong.thoiGianKetThuc.split(":")[0]),
                                            parseInt(sanBong.thoiGianKetThuc.split(":")[1])
                                        ),
                                        allDay: false,
                                        editable: true,
                                        className: 'event-class',
                                        extendedProps: {
                                            trangThai: 'NEW',
                                            classCustom: 'event-class',
                                            giaSan: formatCurrencyVND(sanBong.giaSanCa ) ,
                                            idSanCa: sanBong.id,
                                        },
                                    };
                                    calendar.addEvent(event);
                                    calendar.render();
                                    var eventNew = getEventNew();
                                    addDateToFormDatLich(eventNew);
                                }
                            },
                            error: function (e) {
                                console.log("ERROR: ", e);
                            }
                        });


                    } else {
                        //tạo ra event
                        createAndShowToast("bg-warning", "Thông báo", "ca của ngày đã có người đặt vui lòng chọn ca khác");
                    }
                },
                error: function (e) {
                    console.log("ERROR: ", e);
                }
            });

        });
    });

    function addDateToFormDatLich(eventNew) {
        $("#listEventNew").html('');

        var comboboxCa = "<select class=\"form-select\" id='selectCaDatLichs' aria-label=\"Default select example\"> <option selected disabled value=\"\">Chọn ca </option>";

        $.ajax({
            type: "GET",
            contentType: "application/json",
            url: "/api/v1/user/ca/get-all-ca?idLoaiSan=" + selectedValue,
            dataType: 'json',
            success: function (responseData) {

                var options = responseData.map(function (item) {

                    const startTimeVietnam = formatTime(item.thoiGianBatDau);
                    const endTimeVietnam = formatTime(item.thoiGianKetThuc);

                    return `<option value="${item.id}" data-gia-san="${item.giaSanCa}">${item.tenCa} (${startTimeVietnam} - ${endTimeVietnam})</option>`;
                }).join(''); // Use .join('') to concatenate the option elements.

                comboboxCa = comboboxCa + options + '</select>';


                 // Lấy ngày hôm nay
                var today = new Date().toISOString().split('T')[0];

                const addNewRow = `
                <tr>
                <td style="width: 270px;">${comboboxCa}</td>
                <td ><input type="date" class="form-control" id="datepicker" min="${today}"></td>
                <td>New giá</td>
                <td class="rowOrd">
                <div class="d-flex flex-column">
                      <button class="btn btn-primary btn-sm add-row">Thêm ca</button>
                </div>
                </td>
                </tr>
                `;

                // Thêm dòng đầu tiên vào #listEventNew
                $("#listEventNew").prepend(addNewRow);
            },
            error: function (e) {
                console.log("ERROR: ", e);
            }
        });

        var tongTien = 0;


        $("#listEventNew").append(eventNew.map(function (item) {
            const startTimeVietnam = item.start.toLocaleTimeString("en-US", {
                timeZone: "Asia/Ho_Chi_Minh",
                hour: "2-digit",
                minute: "2-digit",
            });
            const endTimeVietnam = item.end.toLocaleTimeString("en-US", {
                timeZone: "Asia/Ho_Chi_Minh",
                hour: "2-digit",
                minute: "2-digit",
            });

            // Lấy ra ngày từ sự kiện
            const dateVietnam = item.start.toLocaleDateString("en-US", {
                timeZone: "Asia/Ho_Chi_Minh",
                day: "2-digit",
                month: "2-digit",
                year: "numeric",
            });
            debugger
            tongTien = tongTien + chuyenTienTeSangSo(item.extendedProps.giaSan);
            // Chuyển định dạng ngày tháng năm thành "dd - MM - yyyy"
            const dateParts = dateVietnam.split("/");
            const formattedDate =
                dateParts[1] + "-" + dateParts[0] + "-" + dateParts[2];

            return `
                <tr data-id="${item.extendedProps.idSanCa}">
                <td style="width: 270px;">${item.title + '(' + startTimeVietnam + ' - ' + endTimeVietnam + ')'}</td>
                <td>${formattedDate}</td>
                <td>${item.extendedProps.giaSan}</td>
                <td>
                    <div class="d-flex flex-column">
                        <button class="btn btn-danger btn-sm xoa-san-button" onclick="deleteEventById('${item.id}')">Xóa</button>
                    </div>
                </td>
                </tr>
                `;
        }));
        $('#id_tongTien').text(  formatCurrencyVND(tongTien));
        $('#id_tienCoc').text( formatCurrencyVND(tongTien * (thamSoTienCoc / 100)));
    }

    function formatTime(inputTime) {
        const timeParts = inputTime.split(":");
        const hours = parseInt(timeParts[0]);
        const minutes = parseInt(timeParts[1]);

        const formatWithLeadingZeros = (number) => {
            return number < 10 ? `0${number}` : number.toString();
        };

        const formattedHours = formatWithLeadingZeros(hours);
        const formattedMinutes = formatWithLeadingZeros(minutes);

        let formattedTime = '';

        if (hours === 12) {
            formattedTime = `12:${formattedMinutes} PM`;
        } else if (hours > 12) {
            formattedTime = `${formattedHours - 12}:${formattedMinutes} PM`;
        } else {
            formattedTime = `${formattedHours}:${formattedMinutes} AM`;
        }
        return formattedTime;
    }

    $(document).on("change", "#selectCaDatLichs", function () {
        var selectedGiaSan = $(this).find("option:selected").data("gia-san");
        $(this).closest("tr").find("td:nth-child(3)").text(formatCurrencyVND(selectedGiaSan));
    });
</script>
<!--//doi lich one user-->
<script>
    // <!--    check input date là ngày hiện tại-->
    const currentDate = new Date();
    const inputElement = document.getElementById('dateInput');
    inputElement.setAttribute('min', currentDate.toISOString().substring(0, 10));
    $(document).ready(() => {
        callApiPhanTramTienCoc();
        $(".closeXacNhanOne").click(() => {
            $("#modalConfirmDoiLich").modal('hide');
            $('.modal-backdrop').remove();
        })
    });

    // <!--    check input date là ngày hiện tại-->
    function doiSanDetail(id) {
        // $("#doiLichOne").modal('hide');
        // var modalBackdrop = $('.modal-backdrop');
        // if (modalBackdrop.length > 0) {
        //     modalBackdrop.remove();
        // }
        $.ajax({
            type: "GET",
            url: "http://localhost:8081/api/v1/user/doi-lich/one/" + id,
            success: function (response) {
                debugger
                if (response.statusCode == 'ALREADY_REPORTED') {
                    $("#doiLichOne").modal('hide');
                    $('.modal-backdrop').remove();
                    createAndShowToast("bg-danger", "Thông báo", "Bạn không đủ điều kiện để đổi lịch này!");
                    return;
                }
                if (response.statusCode == 'BAD_REQUEST') {
                    $("#doiLichOne").modal('hide');
                    $('.modal-backdrop').remove();
                    createAndShowToast("bg-danger", "Thông báo", "Không thể thực hiện!");
                    return;
                }

                console.log(response)
                modalDL.lichDatCu.id = response.content.id,
                    modalDL.lichDatCu.caHT = response.content.tenCa,
                    modalDL.lichDatCu.loaiSan = response.content.tenLoaiSan,
                    modalDL.lichDatCu.ngayDaDuKien = response.content.ngayDenSan,
                    modalDL.lichDatCu.thoiGianBatDau = response.content.thoiGianBatDau,
                    modalDL.lichDatCu.thoiGianKetThuc = response.content.thoiGianKetThuc,
                    modalDL.lichDatCu.tienSan = response.content.tienSan,
                    modalDL.lichDatCu.idCa = response.content.idCa,
                    modalDL.lichDatCu.idLoaiSan = response.content.idLoaiSan,
                    modalDL.checkLich.idCa = response.content.idCa,
                    modalDL.checkLich.idLoaiSan = response.content.idLoaiSan,
                    modalDL.lichDatCu.idSanBong = response.content.idSanBong,
                    modalDL.tienPhaiTra = response.content.tienSan,
                    modalDL.lichDatCu.giaCa = response.content.giaCa,
                    modalDL.lichDatCu.giaSan = response.content.giaSan,
                    modalDL.lichDatCu.countDoiLich = response.content.countDoiLich
                callApiLoaiSanAndCaOne();
                if (modalDL.lichDatCu.countDoiLich === 1) {
                    $("#doiLichOne").modal('hide');
                    $('.modal-backdrop').remove();
                    createAndShowToast("bg-danger", "Thông báo", "Bạn chỉ được đổi lịch 1 lần duy nhất! Cảm ơn!");
                    return;
                }

                $('#doiLichOne').modal('show');

            },
            error: function (error) {
                console.log(error);
                alert("Lỗi!");
            }
        })
    }

    function callApiLoaiSanAndCaOne() {
        $.ajax({
            type: "GET",
            url: "http://localhost:8081/api/v1/user/doi-lich/list-san-list-ca",
            success: function (response) {
                modalDL.listCa = response.content.ca,
                    modalDL.listLoaiSan = response.content.loaiSan
            },
            error: function (error) {
                console.log(error);
                alert("Lỗi!");
            }
        })
    }

    function callApiPhanTramTienCoc() {
        $.ajax({
            type: "GET",
            url: "http://localhost:8081/api/v1/user/doi-lich/find-by-tien-coc",
            success: function (response) {
                modalDL.phanTramCoc = parseInt(response.content);
            },
            error: function (error) {
                console.log(error);
            }
        });
    }
</script>
<script>
    var modalDL = new Vue({
        el: "#doiLichOne",
        data: {
            listLoaiSan: [],
            listCa: [],
            lichDatCu: {
                id: "",
                idCa: "",
                caHT: "",
                giaCa: 0,
                idLoaiSan: "",
                loaiSan: "",
                tienLoaiSan: "",
                idSanBong: "",
                ngayDaDuKien: "",
                thoiGianBatDau: "",
                thoiGianKetThuc: "",
                giaSan: 0,
                countDoiLich: 0,
            },
            ngayMuonDoi: "",
            tienPhaiTra: 0,
            checkLich: {
                idLoaiSan: "",
                idCa: ""
            },
            tienCocThieu: 0,
            tienCocThua: 0,
            phanTramCoc: 0,
            noiDung: "Tien coc san bong",
            indexCheckLich: 0,
        },
        methods: {
            selectCaDoiLich(event) {
                this.listCa.forEach((elment) => {
                    if (elment.id == event.target.value) {
                        this.lichDatCu.giaCa = elment.giaCa;
                        this.lichDatCu.idCa = elment.id;
                        this.tienPhaiTra = parseFloat(elment.giaCa) + this.lichDatCu.giaSan;
                    }
                })
            },
            selectLoaiSanDoiLich(event) {
                this.listLoaiSan.forEach((elment) => {
                    if (elment.id == event.target.value) {
                        this.lichDatCu.giaSan = elment.giaSan;
                        this.lichDatCu.idLoaiSan = elment.id;
                        this.tienPhaiTra = parseFloat(elment.giaSan) + parseFloat(this.lichDatCu.giaCa);
                    }
                })
            },
            btnXacNhanDoiLich() {
                this.findLichDat();
                if (this.lichDatCu.ngayDaDuKien == $(".ngayMuonDoi").val()
                    && this.lichDatCu.idLoaiSan == this.checkLich.idLoaiSan
                    && this.lichDatCu.idCa == this.checkLich.idCa) {
                    createAndShowToast("bg-warning", "Thông báo", "Lịch không có gì thay đổi! Vui lòng xem lại!");

                    $(".modalCon").prop("hidden", true);
                    $('.modal-backdrop').remove();
                    return;
                }
                if (this.checkTienCoc() === 0) {
                    $(".modalCon").prop("hidden", false);
                    return;
                }
                // alert(modalDL.indexCheckLich )

                $.ajax({
                    type: "GET",
                    url: "http://localhost:8081/api/v1/user/doi-lich/check-lick-dat?idLS=" + this.lichDatCu.idLoaiSan + "&idCa=" + this.lichDatCu.idCa + "&ngayDoi=" + $(".ngayMuonDoi").val(),
                    success: function (response) {
                        if (response.content === 1) {
                            $(".modalCon").prop("hidden", true);
                            $('.modal-backdrop').remove();
                            createAndShowToast("bg-danger", "Thông báo", "Đã có lịch đặt");
                            return;
                        }

                        if (response.content === 2) {
                            $(".modalCon").prop("hidden", true);
                            $('.modal-backdrop').remove();
                            createAndShowToast("bg-danger", "Thông báo", "Lỗi");
                            return;
                        }
                        $(".modalCon").prop("hidden", true);
                        $('.modal-backdrop').remove();
                        if (confirm("Bạn có chắc chắn thực hiện không?")) {
                            modalDL.updateLichOne();
                        }
                    }, error: function (error) {
                        createAndShowToast("bg-danger", "Thông báo", "Lỗi");
                        console.log(error);
                    }
                });

            },
            updateLichOne() {
                $.ajax({
                    type: "POST",
                    url: "http://localhost:8081/api/v1/user/doi-lich/update-lich",
                    dataType: "json",
                    contentType: "application/json",
                    data: JSON.stringify({
                        idHDSC: this.lichDatCu.id,
                        idCa: this.lichDatCu.idCa,
                        idLoaiSan: this.lichDatCu.idLoaiSan,
                        idSanBong: this.lichDatCu.idSanBong,
                        tienSan: this.tienPhaiTra,
                        ngayDoi: $(".ngayMuonDoi").val(),
                        tienCocThieu: this.tienCocThieu,
                        tienCocThua: this.tienCocThua
                    }),
                    success: function (response) {
                        window.location.reload();
                        createAndShowToast("bg-success", "Thông báo", "Thao tác thành công!");
                    },
                    error: function (error) {
                        console.log(error);
                        createAndShowToast("bg-danger", "Thông báo", "Thao tác thất bại!");
                    }
                })
            },
            findLichDat() {
                $.ajax({
                    type: "POST",
                    url: "http://localhost:8081/api/v1/user/tien-coc/one",
                    dataType: "json",
                    contentType: "application/json",
                    data: JSON.stringify({
                        idHDSC: this.lichDatCu.id,
                        idCa: this.lichDatCu.idCa,
                        idLoaiSan: this.lichDatCu.idLoaiSan,
                        idSanBong: this.lichDatCu.idSanBong,
                        tienSan: this.tienPhaiTra,
                        ngayDoi: $(".ngayMuonDoi").val(),
                        tienCocThieu: this.tienCocThieu,
                        tienCocThua: this.tienCocThua
                    }),
                    success: function (response) {
                        console.log(response)
                    },
                    error: function (error) {
                        console.log(error);
                        createAndShowToast("bg-danger", "Thông báo", "Thao tác thất bại!");
                    }
                })
            },
            checkTienCoc() {
                if (this.lichDatCu.tienSan < this.tienPhaiTra) {
                    return 0;
                } else if (this.lichDatCu.tienSan > this.tienPhaiTra) {
                    return 1;
                }
                return 2;
            },
            tinhTienCoc() {
                if (this.checkTienCoc() === 0) {
                    this.tienCocThieu = (parseFloat(this.tienPhaiTra) - parseFloat(this.lichDatCu.tienSan)) * (this.phanTramCoc / 100);
                    return this.tienCocThieu;
                } else if (this.checkTienCoc() === 1) {
                    this.tienCocThua = (parseFloat(this.lichDatCu.tienSan) - parseFloat(this.tienPhaiTra)) * (this.phanTramCoc / 100);
                    return this.tienCocThua;
                }
            },
            currenDateLichOne(date) {
                return moment(date).format("DD-MM-YYYY");
            },
            currenNumberVNLichOne(number) {
                if (number !== undefined && number !== null) {
                    return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(number);
                    // return number.toLocaleString("vi-VN");
                } else {
                    return 0;// hoặc có thể trả về giá trị mặc định khác
                }
            }

        }
    })

</script>
<!--//doi lich one user
//doi lich nhieu-->
<script>
    var app = new Vue({
        el: ".app",
        data: {
            arrCaDL: [],
            arrLoaiSanDL: [],
            arrLichCanDoi: [],
            arrXacNhanLich: [],
            tongTienSanCu: 0,
            tongTienSanMoi: 0,
            giaDukienChung: 0,
            phanTramTienCocLichNhieu: 0,
            tienCocThieuDoiLichNhieu: 0,
            tienCocThuaDoiLichNhieu: 0,
            sanCaCheckRequest: [],
            listDataDoiLichNhieuRequest: [],
            boolCheckLich: false,
            listCheck: [],
        },
        methods: {
            currenlyNumberVue(number) {
                // return number.toLocaleString("vi-VN");
                return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(number);
            },
            getByIdCa(id) {
                var ca = null;
                this.arrCaDL.forEach((item) => {
                    if (item.id == id) {
                        ca = item;
                        return;
                    }
                });
                return ca;
            },
            getByIdLoaiSan(id) {
                var lSan = null;
                this.arrLoaiSanDL.forEach((item) => {
                    if (item.id == id) {
                        lSan = item;
                        return;
                    }
                });
                return lSan;
            },
            currenDateDLN(date) {
                return moment(date).format("DD-MM-YYYY");
            },
            currenDateUKDLN(date) {
                return moment(date).format("YYYY-MM-DD");
            },
            dateNow() {
                const currentDateNhieu = new Date();
                return currentDateNhieu.toISOString().substring(0, 10);
            },
            currenDateLichNhieu(date) {
                if (date !== undefined && date !== null) {
                    return moment(date).format("DD-MM-YYYY");
                }
                return "Null";
            },
            currenNumberLichNhieu(number) {
                if (number !== undefined && number !== null) {
                    // return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(number);
                    return number.toLocaleString("vi-VN");
                } else {
                    return 0;// hoặc có thể trả về giá trị mặc định khác
                }
            },
            tinhTienCocLichNhieu() {
                let phanTramTienCoc = parseInt(this.phanTramTienCocLichNhieu);
                if (this.checkTienDoiLichNhieu() === 0) {
                    this.tienCocThieuDoiLichNhieu = (parseFloat(this.tongTienSanMoi) - parseFloat(this.tongTienSanCu)) * (phanTramTienCoc / 100);
                    console.log(this.tienCocThieuDoiLichNhieu)
                    return this.tienCocThieuDoiLichNhieu;
                }
                if (this.checkTienDoiLichNhieu() === 1) {
                    this.tienCocThuaDoiLichNhieu = (parseFloat(this.tongTienSanCu) - parseFloat(this.tongTienSanMoi)) * (phanTramTienCoc / 100);
                    return this.tienCocThuaDoiLichNhieu;
                }
                return
            },
            checkTienDoiLichNhieu() {
                if (parseFloat(this.tongTienSanMoi) > parseFloat(this.tongTienSanCu)) {
                    return 0;
                }
                if (parseFloat(this.tongTienSanMoi) < parseFloat(this.tongTienSanCu)) {
                    return 1;
                }
                return 2;
            },
            thanhToanTienCocLichNhieu(event) {
                event.preventDefault();
                var arrTB = [];
                var shouldSubmitDefault = false;
                $.ajax({
                    type: "POST",
                    dataType: "json",
                    contentType: "application/json",
                    url: "http://localhost:8081/api/v1/user/san-ca/check-list-san-ca",
                    data: JSON.stringify(this.sanCaCheckRequest),
                    success: function (response) {
                        if (response.length > 0) {

                            response.forEach((items) => {
                                var error = ["bg-warning", "Thông báo", app.getByIdCa(items.idCa).tenCa + " của ngày " +
                                items.ngayDat + " hiện tại đã có người đặt. Vui lòng kiểm tra lại"];
                                arrTB.push(error);
                            });
                            createMultipleToasts(arrTB);
                            return;
                        }
                        app.callApiListDoiLichNhieuList();
                        shouldSubmitDefault = true;

                    }, error: function (error) {
                        console.log(error);
                    },
                    complete: function () {
                        if (shouldSubmitDefault) {
                            var form = $(event.target).closest('form')[0];
                            if (form && form.tagName === "FORM") {
                                form.submit();
                            } else {
                                console.error("Không thể tìm thấy đối tượng form hợp lệ.");
                            }
                        }
                    }
                });
            },
            callApiListDoiLichNhieuList() {
                $.ajax({
                    type: 'POST',
                    dataType: 'JSON',
                    contentType: 'application/json',
                    url: "http://localhost:8081/api/v1/user/thanh-toan-nhieu/find-list-doi-lich",
                    data: JSON.stringify(app.listDataDoiLichNhieuRequest),
                    success: function (response) {
                        console.log(response);
                    },
                    error: function (error) {
                        createAndShowToast("bg-warning", "Thông báo", "Không thể thực hiện!");
                        console.log(error);
                    }
                });
            }
        }
    });
</script>
<script>
    function updateNgayMuonDoi() {
        const ngayMuonDoiInputs = $(".change-time");
        ngayMuonDoiInputs.each((index, element) => {
            $(element).val(list[index]);
        });
    }

    $(function () {
        // Theo tuan
        $("#datLichTheoTuans")
            .mobiscroll()
            .datepicker({
                controls: ["calendar"],
                display: "inline",
                rangeSelectMode: "wizard",
                select: "range",
                showRangeLabels: true,
                min: new Date(),
                onChange: function (event, inst) {
                    var arrStartEnd = event.value;
                    var startDate = new Date(arrStartEnd[0]); // Ngày bắt đầu
                    var endDate = new Date(arrStartEnd[1]); // Ngày kết thúc
                    var dateArr = [];
                    while (startDate <= endDate) {
                        dateArr.push(
                            moment(startDate, "DD/MM/YYYY").format("YYYY-MM-DD")
                        );
                        startDate.setDate(startDate.getDate() + 1);
                    }
                    if (dateArr.length > app.arrLichCanDoi.length) {

                        createAndShowToast("bg-warning", "Thông báo", 'Số bản ghi của bạn chỉ có ' + app.arrLichCanDoi.length + ', vui lòng bớt ngày chọn!');
                        inst.setVal([], true, true);
                        return;
                    }

                    if (dateArr.length > 1) {
                        dateArr.forEach((items) => {
                            list = [];
                            list = dateArr.slice();
                        });
                        updateNgayMuonDoi();
                    }
                },
            });
    });
    mobiscroll.setOptions({
        locale: mobiscroll.localeVi,
        theme: "ios",
        themeVariant: "light",
    });
    var list = [];
    $(function () {
        // Theo ngay
        var counterNumber = $("#demo-counter")
            .mobiscroll()
            .datepicker({
                controls: ["calendar"],
                display: "inline",
                selectMultiple: true,
                selectCounter: true,
                min: new Date(),
                onChange: function (event, inst) {
                    if (parseInt(inst.getVal().length) > app.arrLichCanDoi.length) {
                        createAndShowToast("bg-warning", "Thông báo", 'Số bản ghi của bạn chỉ có ' + app.arrLichCanDoi.length + ', vui lòng bớt ngày chọn!');
                        var selectedDates = inst.getVal();
                        selectedDates.pop();
                        inst.setVal(selectedDates);
                        return;
                    }
                    list = [];
                    var listDate = event.valueText.split(",");
                    listDate.forEach((element) => {
                        list.push(moment(element, "DD/MM/YYYY").format("YYYY-MM-DD"));
                    });
                    updateNgayMuonDoi();
                },
            });
    });
</script>
<script>

    $(document).ready(function () {

        $(".btnDoiLichNhanh").click(() => {
            callApiDoiLich();
            callApiLoaiSanAndCaNhieu();
        });
        updateNgayMuonDoi();
        checkNowDate();
        checkDate();
        //xac nhan
        xacNhanDoiLich();
        eventGiaDuKien();
        callApiPhanTramTienCocDoiLichNhieu();
        $(".closeModalXacNhanThongTinCon").click(() => {
            $("#modalConfirm").modal('hide');
            $('.modal-backdrop').remove();
        });
        doiLichNhieuDuTienCocHoacKhong();
    });


    function eventGiaDuKien() {
        $(document).on("change", ".ca-sb, .loai-san", function () {
            var $row = $(this).closest("tr"); // Tìm phần tử cha <tr>
            var giaDuKien = 0;
            var giaCa = 0;
            var giaLoaiSan = 0;

            var selectedCaId = $row.find(".ca-sb").val();
            var selectedLoaiSanId = $row.find(".loai-san").val();

            // Tính giá Ca
            app.arrCaDL.forEach((element) => {
                if (element.id == selectedCaId) {
                    giaCa = parseFloat(element.giaCa);
                }
                listCheckBoxCheckKed();
            });

            // Tính giá Loại sân
            app.arrLoaiSanDL.forEach((element) => {
                if (element.id == selectedLoaiSanId) {
                    giaLoaiSan = parseFloat(element.giaSan);
                }
            });

            // Tính giá dự kiến
            giaDuKien = giaCa + giaLoaiSan;
            app.giaDukienChung = giaDuKien;
            // Cập nhật giá dự kiến chỉ cho dòng hiện tại
            var giaDuKienFormat = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(parseInt(giaDuKien));;
            $row.find(".giaDuKienPhaiTra").text(giaDuKienFormat);
            listCheckBoxCheckKed();
        });
    }

    //doi lich cos du tien coc hoac khong
    function doiLichNhieuDuTienCocHoacKhong() {

        $(document).on('click', '.doiLichNhieuDuTienHoacKhong', function () {
            var arrTB = [];
            $.ajax({
                type: "POST",
                dataType: "json",
                contentType: "application/json",
                url: "http://localhost:8081/api/v1/user/san-ca/check-list-san-ca",
                data: JSON.stringify(app.sanCaCheckRequest),
                success: function (response) {
                    if (response.length > 0) {
                        response.forEach((items) => {
                            var error = ["bg-warning", "Thông báo", app.getByIdCa(items.idCa).tenCa + " của ngày " +
                            items.ngayDat + " hiện tại đã có người đặt. Vui lòng kiểm tra lại"];
                            arrTB.push(error);
                        });
                        createMultipleToasts(arrTB);
                        return;
                    }
                    updateLichNhieuKoVNPay();

                }, error: function (error) {
                    console.log(error);
                }
            });
        });
    };

    function updateLichNhieuKoVNPay() {
        $.ajax({
            type: 'POST',
            dataType: 'JSON',
            contentType: 'application/json',
            url: "http://localhost:8081/api/v1/user/doi-lich/update-lich-nhieu",
            data: JSON.stringify(app.listDataDoiLichNhieuRequest),
            success: function (response) {
                if (response.statusCode === 'OK') {
                    createAndShowToast("bg-success", "Thông báo", "Thao tác đổi lịch thành công!");
                    setTimeout(function () {
                        window.location.reload();
                    }, 1000);
                    return;
                }
                createAndShowToast("bg-warning", "Thông báo", "Không thể thực hiện!");
            },
            error: function (error) {
                createAndShowToast("bg-warning", "Thông báo", "Không thể thực hiện!");
                console.log(error);
            }
        });
    }


    function xacNhanDoiLich() {
        // $(".btnGuiXacNhan").click((event) => {
        $(".modalXacNhan").click((event) => {
            event.preventDefault();
            var checkedData = [];
            var dataRow = {};
            var dataRequest = {};
            var dataCheckEmpty = {};
            app.listDataDoiLichNhieuRequest = [];
            app.sanCaCheckRequest = [];
            var checkboxes = document.querySelectorAll(".check-one");
            checkboxes.forEach(function (checkbox) {
                if (checkbox.checked) {
                    var row = checkbox.closest("tr");
                    var id = row.querySelector("input.check-one").value;
                    var caCu = row.querySelector("td.ca-ht").textContent;
                    var loaiSanCu = row.querySelector("td.loai-san-ht").textContent;
                    var ngayDaCu = row.querySelector("td.time-da-bong").textContent;
                    var giaCu = row.querySelector("td.tong-tien").textContent;
                    var caNew = row.querySelector("select.ca-sb").value;
                    var loaiSanNew = row.querySelector("select.loai-san").value;
                    var giaNew = row.querySelector("td.giaDuKienPhaiTra").textContent;
                    var ngayNew = row.querySelector("input.change-time").value == "" ? app.currenDateUKDLN(ngayDaCu) : app.currenDateUKDLN(row.querySelector("input.change-time").value);
                    dataRow = {id, caCu, loaiSanCu, ngayDaCu, giaCu, caNew, ngayNew, loaiSanNew, giaNew, ngayNew};
                    checkedData.push(dataRow);
                    dataCheckEmpty = {
                        id: id,
                        idLoaiSan: loaiSanNew,
                        idCa: caNew,
                        ngayDat: ngayNew,
                    };
                    app.sanCaCheckRequest.push(dataCheckEmpty);
                    var tienCocThieu = 0;
                    var tienCocThua = 0;
                    var valuePhanTram = parseInt(app.phanTramTienCocLichNhieu);
                    if (parseFloat(app.tongTienSanMoi) > parseFloat(app.tongTienSanCu)) {
                        tienCocThieu = (parseInt(app.tongTienSanMoi) - parseInt(app.tongTienSanCu)) * (valuePhanTram / 100);
                    } else if (parseFloat(app.tongTienSanMoi) < parseFloat(app.tongTienSanCu)) {
                        tienCocThua = (parseInt(app.tongTienSanCu) - parseInt(app.tongTienSanMoi)) * (valuePhanTram / 100);
                    }
                    dataRequest = {
                        idHDSC: id,
                        idCa: caNew,
                        idLoaiSan: loaiSanNew,
                        ngayDoi: ngayNew,
                        tienSan: giaNew.replace(/\D/g, ''),
                        tienCocThieu: tienCocThieu,
                        tienCocThua: tienCocThua
                    };
                    app.listDataDoiLichNhieuRequest.push(dataRequest);
                }
            });
            if (checkedData.length === 0) {
                // Đóng modal
                $("#modalConfirm").modal("hide");
                $('.modal-backdrop').remove();
                createAndShowToast("bg-warning", "Thông báo", "Vui lòng chọn lịch bạn muốn thay đổi!");
            }
            app.arrXacNhanLich = checkedData;

        });
    }

    //check truoc ngay hien tai
    function checkNowDate() {
        // khong chon truoc ngay hien tai start
        // Lấy ngày hiện tại
        var currentDate = new Date().toISOString().split("T")[0];

        // Xử lý tất cả các trường nhập có id là "datePicker"
        $("input#datePicker").each(function () {
            // Thiết lập giá trị tối thiểu cho trường nhập ngày
            $(this).attr("min", currentDate);

            // Xử lý sự kiện onchange để ngăn chọn ngày trước ngày hiện tại
            $(this).on("change", function () {
                if ($(this).val() < currentDate) {
                    $(this).val(currentDate);
                }
            });
        });

        // khong chon truoc ngay hien tai end
    }

    //call api
    function callApiDoiLich() {

        $.ajax({
            type: "GET",
            url: "http://localhost:8081/api/v1/user/doi-lich/list-lich-doi",
            dataType: "json",
            success: function (response) {
                console.log(response)
                app.arrLichCanDoi = response.content;
                response.content.forEach((items) => {

                });
            },
            error: function (error) {
                console.log(error);
            },
        });
    }

    //call api
    function callApiLoaiSanAndCaNhieu() {
        $.ajax({
            type: "GET",
            url: "http://localhost:8081/api/v1/user/doi-lich/find-all-loai-san-ca",
            dataType: "json",
            success: function (response) {
                app.arrCaDL = response.content.ca;
                app.arrLoaiSanDL = response.content.loaiSan;
            },
            error: function (error) {
                console.log(error);
            },
        });
    }

    //event chung
    function checkDate() {
        $(".check-all").change(function () {
            if (this.checked) {
                $(".gather").prop("hidden", false);
                $(".check-one").prop("checked", true);
            } else {
                $(".check-one").prop("checked", false);
                $(".gather").prop("hidden", true);
            }
            listCheckBoxCheckKed();
        });

        $(document).on('click', '.check-one', function () {
            var lengCheckOne = $(".check-one").length;
            var lengChecked = $(".check-one:checked").length;
            if (lengCheckOne == lengChecked) {
                $(".check-all").prop("checked", true);
                $(".gather").prop("hidden", false);
            } else {
                $(".check-all").prop("checked", false);
                $(".gather").prop("hidden", true);
            }
            //
            listCheckBoxCheckKed();
        });

        //cac ca chung
        $(".ca-chung").change((event) => {
            $(".ca-sb").val(event.target.value);
            $(".loai-san").val($(".loai-san-chung").val());
            giaDuKienChung(event, $(".loai-san-chung").val(), 0);
        });
        //loai san chung
        $(".loai-san-chung").change((event) => {
            $(".loai-san").val(event.target.value);
            $(".ca-sb").val($(".ca-chung").val());
            giaDuKienChung(event, $(".ca-chung").val(), 1);
        });
        ///
        $(".btnTheoNgay").addClass("active");
        $(".btnTheoNgay").click(() => {
            $(".btnTheoNgay").addClass("active");
            $(".btnTheoTuan").removeClass("active");
            $(".dateTheoNgay").prop("hidden", false);
            $(".dateTheoTuan").prop("hidden", true);
        });
        $(".btnTheoTuan").click(() => {
            $(".btnTheoTuan").addClass("active");
            $(".btnTheoNgay").removeClass("active");
            $(".dateTheoNgay").prop("hidden", true);
            $(".dateTheoTuan").prop("hidden", false);
        });
    }

    function listCheckBoxCheckKed() {
        var checkboxes = document.querySelectorAll(".check-one");
        app.tongTienSanCu = 0;
        app.tongTienSanMoi = 0;
        checkboxes.forEach((checkbox) => {
            if (checkbox.checked) {
                var row = checkbox.closest("tr");
                var giaCu = row.querySelector("td.tong-tien").textContent;
                app.tongTienSanCu += parseFloat(giaCu.replace(/\D/g, ''));
                var giaNew = row.querySelector("td.giaDuKienPhaiTra").textContent;
                app.tongTienSanMoi += parseFloat(giaNew.replace(/\D/g, ''));
            }

        });
    };

    function giaDuKienChung(event, value, index) {
        var giaDuKien = 0;
        var giaCa = 0;
        var giaLoaiSan = 0;
        // Tính giá Ca
        if (index == 0) {
            app.arrCaDL.forEach((element) => {
                if (element.id == event.target.value) {
                    giaCa = parseFloat(element.giaCa);
                }
            });
            // Tính giá Loại sân
            app.arrLoaiSanDL.forEach((element) => {
                if (element.id == value) {
                    giaLoaiSan = parseFloat(element.giaSan);
                }
            });
        } else {
            app.arrCaDL.forEach((element) => {
                if (element.id == value) {
                    giaCa = parseFloat(element.giaCa);
                }
            });
            // Tính giá Loại sân
            app.arrLoaiSanDL.forEach((element) => {
                if (element.id == event.target.value) {
                    giaLoaiSan = parseFloat(element.giaSan);
                }
            });
        }

        giaDuKien = giaCa + giaLoaiSan;
        app.tongTienSanMoi = 0;
        app.tongTienSanMoi = parseFloat(giaDuKien) * app.arrLichCanDoi.length;
        var giaDuKienFormatVN = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(giaDuKien);
        $(".giaDuKienPhaiTra").text(giaDuKienFormatVN);
    };

    function callApiPhanTramTienCocDoiLichNhieu() {
        $.ajax({
            type: "GET",
            url: "http://localhost:8081/api/v1/user/doi-lich/find-by-tien-coc",
            success: function (response) {
                app.phanTramTienCocLichNhieu = parseInt(response.content);
            },
            error: function (error) {
                console.log(error);
            }
        });
    }


    // function currenlyNumber(number) {
    //     return number.toLocaleString("vi-VN");
    // }
</script>
<!--//doi lich nhieu
//xoa lich đặt-->
<script>
    $(document).ready(() => {

    });

    function deleteLichSanBong(id) {
        Swal.fire({
            title: "Quý khách có chắc chắn hủy lịch này không? Nếu hủy bạn sẽ mất tiền cọc.",
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Xác nhận',
        }).then((result) => {
            if (result.isConfirmed) {
                deleteLichSan(id);
            }
        });

    }

    function deleteLichSan(id) {
        $.ajax({
            type: "DELETE",
            url: "http://localhost:8081/api/v1/user/huy-lich-dat-san/" + id,
            success: function (response) {
                if(response.statusCode == 'OK'){
                    createAndShowToast("bg-success", "Thông báo", "Thao tác thành công!");
                    resetEventByIdLoaiSan(selectedValue);
                    return;
                }
                createAndShowToast("bg-warning", "Thông báo", "Thao tác thất bại, vui lòng thử lại sau!");
            },
            error: function (error) {
                console.log(error);
                createAndShowToast("bg-warning", "Thông báo", "Thao tác thất bại, vui lòng thử lại sau!");
            }
        });
    }

    function formatCurrencyVND(amount) {
        const formatter = new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND',
        });

        return formatter.format(amount);
    }
    function chuyenTienTeSangSo(tienTe) {

        tienTe = tienTe.toString();

        // Remove all non-numeric characters, except for decimal points, plus and minus signs
        tienTe = tienTe.replace(/[^0-9]/g, '');

        // Parse the string into a number
        tienTe = parseFloat(tienTe);

        // Return the formatted number
        return tienTe;
    }
    function isPastDateTime(dateTimeString) {
        // Chuyển đổi chuỗi ngày giờ thành đối tượng Date
        var inputDate = new Date(dateTimeString);

        // Lấy thời điểm hiện tại
        var currentDate = new Date();

        // So sánh thời điểm đã cho với thời điểm hiện tại
        return inputDate < currentDate;
    }
</script>
<!--//xoa lich đặt-->
</body>
</html>